<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Création de Personnage v2</title>
  <link href="https://fonts.googleapis.com/css2?family=Uncial+Antiqua&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css"/> 
  <style>
    body {
      font-family: 'Uncial Antiqua', cursive;
      background-size: cover;
      background-color: #fdf6e3;
      color: #3b2f1e;
      margin: 0;
      padding: 40px;
    }
    h1, h2 {
      text-align: center;
      text-shadow: 1px 1px 2px #00000050;
    }
    .section {
      position: relative;
      background: rgba(255, 248, 220, 0.9);
      border: 4px solid #8b5e3c;
      border-radius: 12px;
      padding: 50px 20px 20px 20px;
      margin-bottom: 30px;
      box-shadow: 0 0 10px #3b2f1e99;
      overflow: hidden;
    }
    .section h2 {
      position: absolute;
      top: -20px;
      left: 20px;
      background: rgba(255, 248, 220, 0.95);
      padding: 0 10px;
      font-size: 20px;
      color: #5c3b21;
      border: 2px solid #8b5e3c;
      border-radius: 8px;
      box-shadow: 2px 2px 4px #00000040;
      z-index: 2;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 15px;
    }
    .field {
      display: flex;
      flex-direction: column;
    }
    label {
      font-weight: bold;
      margin-bottom: 5px;
      color: #3b2f1e;
    }
    input, textarea, select {
      font-family: 'Uncial Antiqua', cursive;
      padding: 6px 10px;
      font-size: 16px;
      background: #fefae0;
      border: 2px solid #8b5e3c;
      border-radius: 6px;
      box-shadow: inset 0 0 4px #8b5e3c44;
      box-sizing: border-box;
      width: 100%;
    }
    textarea {
      resize: vertical;
      height: 100px;
    }
    button {
      font-family: 'Uncial Antiqua', cursive;
      padding: 10px 30px;
      font-size: 18px;
      background: #8b5e3c;
      color: #fefae0;
      border: 2px solid #5c3b21;
      border-radius: 8px;
      cursor: pointer;
      margin: 20px auto;
      display: block;
    }
    button:hover {
      background: #5c3b21;
    }
    @media (max-width: 768px) {
      .grid { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 480px) {
      .grid { grid-template-columns: 1fr; }
    }
    .sort-row {
      background: rgba(139, 94, 60, 0.1);
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 8px;
      display: grid;
      grid-template-columns: 2fr 1fr 1fr;
      gap: 10px;
      align-items: center;
    }
    .add-btn {
      font-family: 'Uncial Antiqua', cursive;
      background: #8b5e3c;
      color: #fefae0;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 10px;
    }
    .add-btn:hover {
      background: #5c3b21;
    }
  </style>
</head>
<body>
  <h1>Création de Personnage v2</h1>
  <div class="section">
    <h2>Informations Générales</h2>
    <div class="grid">
      <div class="field"><label>Nom</label><input id="player_name" type="text"></div>
      <div class="field"><label>Classe</label><select id="player_class"></select></div>
      <div class="field"><label>Race</label><select id="player_race"></select></div>
      <div class="field"><label>Niveau</label><input id="player_level" type="number" min="1"></div>
    </div>
  </div>
  <div class="section">
    <h2>Statistiques</h2>
    <div class="grid">
      <div class="field"><label>Force</label><input id="stat_force" type="number"></div>
      <div class="field"><label>Dextérité</label><input id="stat_dexterite" type="number"></div>
      <div class="field"><label>Magie</label><input id="stat_magie" type="number"></div>
      <div class="field"><label>Constitution</label><input id="stat_constitution" type="number"></div>
      <div class="field"><label>Charisme</label><input id="stat_charisme" type="number"></div>
      <div class="field"><label>Perception</label><input id="stat_perception" type="number"></div>
      <div class="field"><label>Chance</label><input id="stat_chance" type="number"></div>
      <div class="field"><label>Intelligence</label><input id="stat_intelligence" type="number"></div>
    </div>
  </div>
  <div class="section">
    <h2>Survie et Défense</h2>
    <div class="grid">
      <div class="field"><label>Vie</label><input id="player_hp" type="number"></div>
      <div class="field" style="display: none;"><input id="player_hp_current" type="hidden"></div>
      <div class="field"><label>Mana</label><input id="player_mana" type="number"></div>
      <div class="field" style="display: none;"><input id="player_mana_current" type="hidden"></div>
      <div class="field"><label>Vie bonus</label><input id="def_bonus_vie" type="number"></div>
      <div class="field"><label>Intox.</label><input id="def_intox" type="text"></div>
    </div><!-- fin du grid -->
  </div>

    <div class="sections-container">
        <!-- Section Sac -->
        <div class="section">
            <h2>Sac</h2>
            <div class="content-area">
                <textarea id="eq_sac"></textarea>
            </div>
        </div>
    
        <!-- Section Ceinture/dos -->
        <div class="section">
            <h2>Ceinture/dos</h2>
            <div class="content-area">
                <textarea id="eq_ceinture"></textarea>
            </div>
        </div>
    
        <!-- Section Armes -->
        <div class="section">
            <h2>Armes</h2>
            <table class="weapons-table">
                <thead>
                    <tr>
                        <th>Type</th>
                        <th>Dégâts</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td><input id="weapon_type_1" type="text"></td><td><input id="weapon_dmg_1" type="text"></td></tr>
                    <tr><td><input id="weapon_type_2" type="text"></td><td><input id="weapon_dmg_2" type="text"></td></tr>
                    <tr><td><input id="weapon_type_3" type="text"></td><td><input id="weapon_dmg_3" type="text"></td></tr>
                    <tr><td><input id="weapon_type_4" type="text"></td><td><input id="weapon_dmg_4" type="text"></td></tr>
                    <tr><td><input id="weapon_type_5" type="text"></td><td><input id="weapon_dmg_5" type="text"></td></tr>
                </tbody>
            </table>
        </div>
    
        <!-- Section Armure -->
        <div class="section">
            <h2>Armures</h2>
            <div class="armor-section">
                <div class="armor-fields">
                  <div class="field"><label>Type d'armure</label><select id="eq_armure"></select></div>
                    <div class="field"><label>Résistance</label><input id="eq_resistance" type="text"></div>
                    <div class="field"><label>Durabilité</label><input id="eq_durabilite" type="number"></div>
                    <div class="field" style="display: none;"><input id="eq_durabilite_current" type="hidden"></div>
      
                    <div class="field">
                      <label>État de l'armure</label>
                      <input type="text" id="player_armor" readonly>
                      <div id="armor_effect" class="status-text"></div>
                    </div>
                    <div class="field" style="display: none;"><input id="def_protection" type="hidden"></div>
                    <div class="field"><label>Valeur protection</label><input id="def_protection_max" type="number"></div>
                  </div>
            </div>
        </div>
    </div>


    <div class="double-section-container">
        <div class="section">
            <h2>Sorts</h2>
            <div id="sorts-container">
                <!-- Les sorts seront ajoutés ici dynamiquement -->
            </div>
            <button type="button" class="add-btn" id="add-sort-btn">Ajouter un sort</button>
        </div>
            
        <div class="section">
            <h2>Attaques Spéciales</h2>
            <div id="attack-special-container">
                    <!-- Les attaques spéciales seront ajoutés ici dynamiquement -->
            </div>
            <button type="button" class="add-btn" id="add-attack-spe-btn">Ajouter une attaque spéciale</button>
        </div>
    </div>

    <div class="section">
        <h2>Sorts mineurs</h2>
        <div id="sorts-mineurs-container">
            <!-- Les sorts mineurs seront ajoutés ici dynamiquement -->
        </div>
        <button type="button" class="add-btn" id="add-sort-mineur-btn">Ajouter un sort mineur</button>
    </div>

  <div class="section">
    <h2>Compétences de classe et passifs</h2>
    <table class="competences-table">
      <thead>
        <tr>
          <th>Nom</th>
          <th>Effets</th>
          <th>Niveau</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><input id="class_skill_name_1" type="text"></td>
          <td><input id="class_skill_effect_1" type="text"></td>
          <td><input id="class_skill_lvl_1" type="number" min="1"></td>
        </tr>
        <tr>
          <td><input id="class_skill_name_2" type="text"></td>
          <td><input id="class_skill_effect_2" type="text"></td>
          <td><input id="class_skill_lvl_2" type="number" min="1"></td>
        </tr>
        <tr>
          <td><input id="class_skill_name_3" type="text"></td>
          <td><input id="class_skill_effect_3" type="text"></td>
          <td><input id="class_skill_lvl_3" type="number" min="1"></td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="section">
    <h2>Compétences spéciales du personnage</h2>
    <div class="field">
      <textarea id="skills_speciales"></textarea>
    </div>
  </div>

  <div class="section">
    <h2>Biographie</h2>
    <div class="field">
      <textarea id="bio"></textarea>
    </div>
  </div>

  <div class="section">
    <h2>Choix de level up et Effets permanents</h2>
    <div class="field">
      <textarea id="levelup"></textarea>
    </div>
  </div>

  <div style="text-align: center;">
    <button id="save_player_creation">Sauvegarder</button>
  </div>

  <script src="navbar.js"></script>
  <script>
    async function loadGameData() {
      try {
        const response = await fetch('/api/game-database');
        if (!response.ok) {
          throw new Error('Erreur lors du chargement des données');
        }
        const gameData = await response.json();

        // Remplir la liste des classes
        const classSelect = document.getElementById('player_class');
        gameData.classes.forEach(classData => {
          const option = document.createElement('option');
          option.value = classData.classe;
          option.textContent = classData.classe;
          classSelect.appendChild(option);
        });

        // Remplir la liste des races
        const raceSelect = document.getElementById('player_race');
        gameData.races.forEach(raceData => {
          const option = document.createElement('option');
          option.value = raceData.race;
          option.textContent = raceData.race;
          raceSelect.appendChild(option);
        });

        // Remplir la liste des armures
        const armorSelect = document.getElementById('eq_armure');
        gameData.armures.forEach(armorData => {
          const option = document.createElement('option');
          option.value = armorData.armure;
          option.textContent = armorData.armure;
          armorSelect.appendChild(option);
        });

      } catch (error) {
        console.error('Erreur:', error);
        alert('Erreur lors du chargement des données du jeu');
      }
    }

    // Appeler la fonction au chargement de la page
    document.addEventListener('DOMContentLoaded', loadGameData);

    document.getElementById('save_player_creation').addEventListener('click', async () => {
      // Vérification basique
    const required = ['player_name', 'player_class', 'player_race', 'player_level'];
    for (const id of required) {
      if (!document.getElementById(id).value) {
        alert('Veuillez remplir tous les champs requis.');
        return;
      }
    }

    try {
    // Copie des valeurs actuelles
    document.getElementById('player_hp_current').value = document.getElementById('player_hp').value;
    document.getElementById('player_mana_current').value = document.getElementById('player_mana').value;
    document.getElementById('eq_durabilite_current').value = document.getElementById('eq_durabilite').value;
    document.getElementById('def_protection').value = document.getElementById('def_protection_max').value;

    // Collecte des sorts
    const sortsMajeurs = [];
    document.querySelectorAll('#sorts-container .sort-row').forEach(row => {
      const select = row.querySelector('select');
      const degats = row.querySelector('input[type="text"]');
      const niveau = row.querySelector('input[type="number"]');
      if (select.value) {
        sortsMajeurs.push({
          nom: select.options[select.selectedIndex].text,
          degats: degats.value,
          niveau: parseInt(niveau.value) || 1
        });
      }
    });

    // Collecte des sorts mineurs
    const sortsMineurs = [];
    document.querySelectorAll('#sorts-mineurs-container .sort-row').forEach(row => {
      const select = row.querySelector('select');
      const degats = row.querySelector('input[type="text"]');
      if (select.value) {
        sortsMineurs.push({
          nom: select.options[select.selectedIndex].text,
          degats: degats.value
        });
      }
    });

    // Collecte des attaques spéciales
    const attackSpecial = [];
    document.querySelectorAll('#attack-special-container .sort-row').forEach(row => {
      const select = row.querySelector('select');
      const degats = row.querySelector('input[type="text"]');
      const niveau = row.querySelector('input[type="number"]');
      if (select.value) {
        attackSpecial.push({
          nom: select.options[select.selectedIndex].text,
          degats: degats.value,
          niveau: parseInt(niveau.value) || 1
        });
      }
    });

    const data = {
      nom: document.getElementById('player_name').value,
      classe: document.getElementById('player_class').value,
      race: document.getElementById('player_race').value,
      niveau: parseInt(document.getElementById('player_level').value) || 1,
      stats: {
        force: parseInt(document.getElementById('stat_force').value) || 0,
        dexterite: parseInt(document.getElementById('stat_dexterite').value) || 0,
        magie: parseInt(document.getElementById('stat_magie').value) || 0,
        constitution: parseInt(document.getElementById('stat_constitution').value) || 0,
        charisme: parseInt(document.getElementById('stat_charisme').value) || 0,
        perception: parseInt(document.getElementById('stat_perception').value) || 0,
        chance: parseInt(document.getElementById('stat_chance').value) || 0,
        intelligence: parseInt(document.getElementById('stat_intelligence').value) || 0
      },
      bio: document.getElementById('bio').value || '',
      sac: document.getElementById('eq_sac').value || '',
      ceinture: document.getElementById('eq_ceinture').value || '',
      armure: {
        type: document.getElementById('eq_armure').value || '',
        resistance: document.getElementById('eq_resistance').value || '',
        durabilite: {
          max: parseInt(document.getElementById('eq_durabilite').value) || 0,
          current: parseInt(document.getElementById('eq_durabilite_current').value) || 0
        },
        protection: {
          max: parseInt(document.getElementById('def_protection_max').value) || 0,
          current: parseInt(document.getElementById('def_protection').value) || 0
        }
      },
      hp: {
        max: parseInt(document.getElementById('player_hp').value) || 0,
        current: parseInt(document.getElementById('player_hp_current').value) || 0
      },
      mana: {
        max: parseInt(document.getElementById('player_mana').value) || 0,
        current: parseInt(document.getElementById('player_mana_current').value) || 0
      },
      bonus_vie: parseInt(document.getElementById('def_bonus_vie').value) || 0,
      intox: document.getElementById('def_intox').value || '0',
      spells: sortsMajeurs,
      sorts_mineurs: sortsMineurs,
      competences: getCompetences(),
      skills_speciales: document.getElementById('skills_speciales').value || '',
      levelup: document.getElementById('levelup').value || '',
      armes: getArmes(),
      attaques_speciales: attackSpecial,
    };

    console.log('Données à envoyer:', data);

    const response = await fetch('/api/joueurs', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });

    if (!response.ok) {
      throw new Error(`Erreur HTTP: ${response.status}`);
    }

    const result = await response.json();
    console.log('Réponse du serveur:', result);
    alert('Joueur enregistré avec succès !');
    window.location.href = '/selecte_player.html';

  } catch (error) {
    console.error('Erreur lors de la sauvegarde:', error);
    alert(`Erreur lors de la sauvegarde: ${error.message}`);
  }
});

// Fonctions utilitaires à ajouter
function getCompetences() {
  const competences = [];
  for (let i = 1; i <= 3; i++) {
    const nom = document.getElementById(`class_skill_name_${i}`).value;
    if (nom) {
      competences.push({
        nom: nom,
        effet: document.getElementById(`class_skill_effect_${i}`).value || '',
        niveau: parseInt(document.getElementById(`class_skill_lvl_${i}`).value) || 1
      });
    }
  }
  return competences;
}

function getArmes() {
  const armes = [];
  for (let i = 1; i <= 5; i++) {
    const type = document.getElementById(`weapon_type_${i}`).value;
    if (type) {
      armes.push({
        type: type,
        degats: document.getElementById(`weapon_dmg_${i}`).value || ''
      });
    }
  }
  return armes;
}

// Après le chargement de la page
async function createSortRow(type = 'majeur') {
    try {
        const response = await fetch('/api/game-database');
        if (!response.ok) throw new Error('Erreur de chargement des sorts');
        const gameData = await response.json();
        
        const sortRow = document.createElement('div');
        sortRow.className = 'sort-row';
        
        // Select pour le nom du sort
        const selectSort = document.createElement('select');
        selectSort.className = 'sort-select';
        
        // Déterminer quelle liste utiliser selon le type
        let sorts;
        switch(type) {
            case 'majeur':
                sorts = gameData.sorts_majeurs;
                break;
            case 'mineur':
                sorts = gameData.sorts_mineurs;
                break;
            case 'special':
                sorts = gameData.attack_special;
                break;
            default:
                sorts = [];
        }
        
        // Option par défaut
        selectSort.innerHTML = '<option value="">Sélectionner un ' + 
            (type === 'special' ? 'attaque' : 'sort') + '</option>';
        
        // Ajouter les options
        sorts.forEach(sort => {
            const option = document.createElement('option');
            option.value = sort.id;
            option.textContent = sort.nom || '';
            option.dataset.degats = sort.degats || '';
            option.dataset.niveau = sort.niveau || '';
            selectSort.appendChild(option);
        });

        // Champs pour les dégâts et le niveau
        const degatsInput = document.createElement('input');
        degatsInput.type = 'text';
        degatsInput.readOnly = true;
        
        const niveauInput = document.createElement('input');
        niveauInput.type = 'number';
        niveauInput.readOnly = true;

        // Événement de changement
        selectSort.addEventListener('change', (e) => {
            const selectedOption = e.target.options[e.target.selectedIndex];
            degatsInput.value = selectedOption.dataset.degats || '';
            niveauInput.value = selectedOption.dataset.niveau || '';
        });

        // Ajouter les éléments à la ligne
        sortRow.appendChild(selectSort);
        sortRow.appendChild(degatsInput);
        if (type === 'majeur' || type === 'special') {
            sortRow.appendChild(niveauInput);
        }

        return sortRow;
    } catch (error) {
        console.error('Erreur:', error);
        alert('Erreur lors du chargement des données');
    }
}

    // Gestionnaire pour le bouton d'ajout de sort majeur
    document.getElementById('add-sort-btn').addEventListener('click', async () => {
        const container = document.getElementById('sorts-container');
        const sortRow = await createSortRow('majeur');
        container.appendChild(sortRow);
    });

    // Gestionnaire pour le bouton d'ajout de sort mineur
    document.getElementById('add-sort-mineur-btn').addEventListener('click', async () => {
        const container = document.getElementById('sorts-mineurs-container');
        const sortRow = await createSortRow('mineur');
        container.appendChild(sortRow);
    });

    // Gestionnaire pour le bouton d'ajout d'attaque spéciale'
    document.getElementById('add-attack-spe-btn').addEventListener('click', async () => {
        const container = document.getElementById('attack-special-container');
        const sortRow = await createSortRow('special');
        container.appendChild(sortRow);
    });
  </script>
</body>
</html>
