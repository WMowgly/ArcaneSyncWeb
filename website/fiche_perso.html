<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Fiche de Personnage</title>
  <link href="https://fonts.googleapis.com/css2?family=Uncial+Antiqua&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css"/> 
  <style>
    body {
      font-family: 'Uncial Antiqua', cursive;
      background-size: cover;
      background-color: #fdf6e3;
      color: #3b2f1e;
      margin: 0;
      padding: 40px;
    }

    h1, h2 {
      text-align: center;
      text-shadow: 1px 1px 2px #00000050;
    }

    .section {
      position: relative;
      background: rgba(255, 248, 220, 0.9);
      border: 4px solid #8b5e3c;
      border-radius: 12px;
      padding: 50px 20px 20px 20px;
      margin-bottom: 30px;
      box-shadow: 0 0 10px #3b2f1e99;
      overflow: hidden;
    }

    .section h2 {
      position: absolute;
      top: -20px;
      left: 20px;
      background: rgba(255, 248, 220, 0.95);
      padding: 0 10px;
      font-size: 20px;
      color: #5c3b21;
      border: 2px solid #8b5e3c;
      border-radius: 8px;
      box-shadow: 2px 2px 4px #00000040;
      z-index: 2;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 15px;
    }

    .grid-3 {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
    }

    .field {
      display: flex;
      flex-direction: column;
    }

    label {
      font-weight: bold;
      margin-bottom: 5px;
      color: #3b2f1e;
    }

    input, textarea {
      font-family: 'Uncial Antiqua', cursive;
      padding: 6px 10px;
      font-size: 16px;
      background: #fefae0;
      border: 2px solid #8b5e3c;
      border-radius: 6px;
      box-shadow: inset 0 0 4px #8b5e3c44;
      box-sizing: border-box;
      width: 100%;
    }

    textarea {
      resize: vertical;
      height: 150px;
    }

    #save-data-btn {
      font-family: 'Uncial Antiqua', cursive;
      padding: 10px 30px;
      font-size: 18px;
      background: #8b5e3c;
      color: #fefae0;
      border: 2px solid #5c3b21;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 2px 2px 4px #3b2f1e66;
      transition: all 0.3s ease;
      margin: 20px 0;
    }

    #save-data-btn:hover {
      background: #5c3b21;
      transform: translateY(-2px);
      box-shadow: 3px 3px 6px #3b2f1e88;
    }

    #save-data-btn:active {
      transform: translateY(0);
      box-shadow: 1px 1px 3px #3b2f1e44;
    }

    .competences-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    .competences-table th, .competences-table td {
      border: 1px solid #8b5e3c;
      padding: 8px;
      text-align: left;
    }

    .competences-table th {
      background-color: rgba(139, 94, 60, 0.2);
    }

    .spells-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
    }

    .spell-item {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 5px;
      margin-bottom: 10px;
    }

    .spell-item label {
      grid-column: 1 / -1;
      margin-bottom: 0;
    }

    @media (max-width: 768px) {
      .grid, .grid-3 {
        grid-template-columns: repeat(2, 1fr);
      }
      .spells-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 480px) {
      .grid, .grid-3 {
        grid-template-columns: 1fr;
      }
    }

    select {
      font-family: 'Uncial Antiqua', cursive;
      padding: 6px 10px;
      font-size: 16px;
      background: #fefae0;
      border: 2px solid #8b5e3c;
      border-radius: 6px;
      box-shadow: inset 0 0 4px #8b5e3c44;
      box-sizing: border-box;
      width: 100%;
      color: #3b2f1e;
      cursor: pointer;
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%238b5e3c' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 10px center;
      background-size: 16px;
      padding-right: 30px;
    }

    select:hover {
      border-color: #5c3b21;
      background-color: #fff8dc;
    }

    select:focus {
      outline: none;
      border-color: #5c3b21;
      box-shadow: 0 0 0 2px #8b5e3c33;
    }

    select option {
      background: #fefae0;
      color: #3b2f1e;
      padding: 8px;
    }

    .header-fields {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 15px;
      margin-bottom: 20px;
    }

    .niveau-race {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 10px;
    }

    .double-section-container {
        display: flex;
        gap: 30px;
        margin-bottom: 30px;
    }

    .double-section-container .section {
        flex: 1;
    }

    .sort-row {
      background: rgba(139, 94, 60, 0.1);
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 8px;
      display: grid;
      grid-template-columns: 2fr 1fr 1fr;
      gap: 10px;
      align-items: center;
    }

    .add-btn {
      font-family: 'Uncial Antiqua', cursive;
      background: #8b5e3c;
      color: #fefae0;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 10px;
    }

    .add-btn:hover {
      background: #5c3b21;
    }

  </style>
</head>
<body>
  <div id="navbar-placeholder"></div>
  <h1>Fiche de Personnage v2</h1>

  <div class="section">
    <h2>Informations Générales</h2>
    <div class="grid">
      <div class="field"><label>Nom</label><input type="text" readonly></div>
      <div class="field"><label>Classe</label><select id="player_class"></select></div>
      <div class="field"><label>Race</label><select id="player_race"></select></div>
      <div class="field"><label>Niveau</label><input type="number" min="1"></div>
    </div>
  </div>

  <div class="section">
    <h2>Statistiques</h2>
    <div class="grid">
      <div class="field"><label>Force</label><input type="number"></div>
      <div class="field"><label>Dextérité</label><input type="number"></div>
      <div class="field"><label>Magie</label><input type="number"></div>
      <div class="field"><label>Constitution</label><input type="number"></div>
      <div class="field"><label>Charisme</label><input type="number"></div>
      <div class="field"><label>Perception</label><input type="number"></div>
      <div class="field"><label>Chance</label><input type="number"></div>
      <div class="field"><label>Intelligence</label><input type="number"></div>
    </div>
  </div>

  <div class="section">
    <h2>Survie et Défense</h2>
    <div class="grid">
      <div class="field">
        <label>Jets de survie</label>
        <div style="display: flex; flex-direction: column; gap: 10px;">
          <!-- Ligne des "Réussi" -->
          <div style="display: flex; align-items: center;">
            <span class="divider-span">Réussi</span>
            <div style="display: flex; gap: 20px;">
              <input type="checkbox" name="survie1" value="reussi">
              <input type="checkbox" name="survie2" value="reussi">
              <input type="checkbox" name="survie3" value="reussi">
            </div>
          </div>
          <!-- Ligne des "Echec" -->
          <div style="display: flex; align-items: center;">
            <span class="divider-span">Échec</span>
            <div style="display: flex; gap: 20px;">
              <input type="checkbox" name="survie1" value="echec">
              <input type="checkbox" name="survie2" value="echec">
              <input type="checkbox" name="survie3" value="echec">
            </div>
          </div>
        </div>
      </div>
        <div class="field"><label>Vie</label><input type="number"></div>
      <div class="field">
        <div class="field"><label>Mana</label><input type="number"></div>
      </div>
      <div class="field" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <div style="display: flex; flex-direction: column;">
          <label>Vie bonus</label>
          <input type="number" id="player_vie_bonus" min="0" placeholder="0">
        </div>
        <div style="display: flex; flex-direction: column;">
          <label>Intox.</label>
          <input type="number" id="player_intox" placeholder="0" min="0" max="100">
        </div>
      </div>

    </div><!-- fin du grid -->
  </div>

    <div class="sections-container">
        <!-- Section Sac -->
        <div class="section">
            <h2>Sac</h2>
            <div class="content-area">
                <textarea></textarea>
            </div>
        </div>
    
        <!-- Section Ceinture/dos -->
        <div class="section">
            <h2>Ceinture/dos</h2>
            <div class="content-area">
                <textarea></textarea>
            </div>
        </div>
    
        <!-- Section Armes -->
        <div class="section">
            <h2>Armes</h2>
            <table class="weapons-table">
                <thead>
                    <tr>
                        <th>Type</th>
                        <th>Dégâts</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td><input type="text"></td><td><input type="text"></td></tr>
                    <tr><td><input type="text"></td><td><input type="text"></td></tr>
                    <tr><td><input type="text"></td><td><input type="text"></td></tr>
                    <tr><td><input type="text"></td><td><input type="text"></td></tr>
                    <tr><td><input type="text"></td><td><input type="text"></td></tr>
                </tbody>
            </table>
        </div>
    
        <!-- Section Armure -->
        <div class="section">
            <div class="armor-section">
                <div class="armor-fields">
                    <div class="field"><label>Type d'armure</label><select id="eq_armure"></select></div>
                    <div class="field"><label>Résistance</label><input type="text"></div>
                    <div class="field"><label>Durabilité</label><input type="number"></div>
      
                    <div class="field">
                      <label>État de l'armure</label>
                      <input type="text" id="player_armor" readonly>
                      <div id="armor_effect" class="status-text"></div>
                    </div>
                    <div class="field"><label>Valeur protection</label><input type="number"></div>
                  </div>
                <!-- Silhouette humaine -->
                <div class="human-silhouette" style="flex-shrink: 0;">
                    <img src="img/silhouette-homme.jpg" alt="Silhouette humaine" style="max-width: 100px; height: auto;">
                </div>
            </div>
        </div>
    </div>


    <div class="double-section-container">
        <div class="section">
            <h2>Sorts</h2>
            <div id="sorts-container">
                <!-- Les sorts seront ajoutés ici dynamiquement -->
            </div>
            <button type="button" class="add-btn" id="add-sort-btn">Ajouter un sort</button>
        </div>
            
        <div class="section">
            <h2>Attaques Spéciales</h2>
            <div class="grid-3">
                <div class="field"><label>Nom</label><input type="text"></div>
                <div class="field"><label>Dégâts</label><input type="text"></div>
                <div class="field"><label>Niveau</label><input type="number" min="1"></div>
                <div class="field"><label>Nom</label><input type="text"></div>
                <div class="field"><label>Dégâts</label><input type="text"></div>
                <div class="field"><label>Niveau</label><input type="number" min="1"></div>
                <div class="field"><label>Nom</label><input type="text"></div>
                <div class="field"><label>Dégâts</label><input type="text"></div>
                <div class="field"><label>Niveau</label><input type="number" min="1"></div>
            </div>
        </div>
    </div>

    <div class="section">
        <h2>Sorts mineurs</h2>
        <div id="sorts-mineurs-container">
            <!-- Les sorts mineurs seront ajoutés ici dynamiquement -->
        </div>
        <button type="button" class="add-btn" id="add-sort-mineur-btn">Ajouter un sort mineur</button>
    </div>

  <div class="section">
    <h2>Compétences de classe et passifs</h2>
    <table class="competences-table">
      <thead>
        <tr>
          <th>Nom</th>
          <th>Effets</th>
          <th>Niveau</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td><input type="number" min="1"></td>
        </tr>
        <tr>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td><input type="number" min="1"></td>
        </tr>
        <tr>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td><input type="number" min="1"></td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="section">
    <h2>Compétences spéciales du personnage</h2>
    <div class="field">
      <textarea></textarea>
    </div>
  </div>

  <div class="section">
    <h2>Biographie</h2>
    <div class="field">
      <textarea></textarea>
    </div>
  </div>

  <div class="section">
    <h2>Choix de level up et Effets permanents</h2>
    <div class="field">
      <textarea></textarea>
    </div>
  </div>

  <div style="text-align: center;">
    <button id="save-data-btn" type="button" onclick="console.log('Clic direct')">Sauvegarder</button>
  </div>

  <script src="navbar.js"></script>
  <script>
    // Options de sélection
      const options = {
        "classes": ["Guerrier", "Paladin", "Mage", "Marchand", "Ranger", "Druide", "Aventurier", "Sorceleur"],
        "races": ["Humain", "Nain", "Elfe", "Draconnir", "Demi-Elfe", "Humnigar", "Ecorfal"],
        "armures": ["Armure légère", "Armure moyenne", "Armure lourde"]
      };

      // Remplir la liste déroulante des classes
      const classSelect = document.getElementById('player_class');
      options.classes.forEach(className => {
        const option = document.createElement('option');
        option.value = className;
        option.textContent = className;
        classSelect.appendChild(option);
      });

      // Remplir la liste déroulante des races
      const raceSelect = document.getElementById('player_race');
      options.races.forEach(raceName => {
        const option = document.createElement('option');
        option.value = raceName;
        option.textContent = raceName;
        raceSelect.appendChild(option);
      });

      // Remplir la liste déroulante des armures
      const armorSelect = document.getElementById('eq_armure');
      options.armures.forEach(armorName => {
        const option = document.createElement('option');
        option.value = armorName;
        option.textContent = armorName;
        armorSelect.appendChild(option);
      });

      window.addEventListener('DOMContentLoaded', () => {
        console.log('Script chargé');
        
        const params = new URLSearchParams(window.location.search);
        const nom = params.get('Nom');

        // Fonction utilitaire pour récupérer la valeur d'un champ
        function getFieldValue(labelText) {
          const field = Array.from(document.querySelectorAll('.field')).find(
            f => f.querySelector('label')?.textContent.trim() === labelText
          );
          return field?.querySelector('input, textarea, select')?.value || '';
        }

        // Fonction utilitaire pour récupérer la valeur numérique d'un champ
        function getNumericValue(labelText) {
          const value = getFieldValue(labelText);
          return value ? parseInt(value) || null : null;
        }

        // Remplir les champs avec les valeurs existantes
        document.querySelectorAll('.field').forEach(field => {
          const label = field.querySelector('label');
          const input = field.querySelector('input, textarea, select');
          if (!label || !input) return;

          const labelText = label.innerText.trim();
          
          if (labelText === 'Vie') {
            input.value = params.get('VieMax') || '';
          } 
          else if (labelText === 'Mana') {
            input.value = params.get('ManaMax') || '';
          }
          else if (labelText === 'Durabilité') {
            input.value = params.get('DuraMax') || '';
          }
          else if (labelText === 'Valeur protection') {
            input.value = params.get('ProtectionMax') || '';
          }
          else {
            const value = params.get(labelText);
            if (value !== null) {
              input.value = value;
            }
          }
        });

        // Mettre à jour le titre de la page avec le nom du personnage
        if (nom) {
          document.querySelector('h1').innerText = `Fiche de ${nom}`;
        }

        // Remplir les valeurs des listes déroulantes
        const classeValue = params.get('Classe');
        if (classeValue) {
          document.getElementById('player_class').value = classeValue;
        }

        const raceValue = params.get('Race');
        if (raceValue) {
          document.getElementById('player_race').value = raceValue;
        }

        const armureValue = params.get("Type d'armure");
        if (armureValue) {
          document.getElementById('eq_armure').value = armureValue;
        }

        // Remplir la biographie
        const bioSection = Array.from(document.querySelectorAll('.section'))
            .find(section => section.querySelector('h2')?.textContent.includes('Biographie'));
        if (bioSection) {
            const bioTextarea = bioSection.querySelector('textarea');
            if (bioTextarea) {
                const biographie = params.get('Biographie');
                if (biographie !== null) {
                    bioTextarea.value = biographie;
                }
            }
        }

        // Remplir le sac et la ceinture/dos
        const sacSection = Array.from(document.querySelectorAll('.section'))
            .find(section => section.querySelector('h2')?.textContent === 'Sac');
        if (sacSection) {
            const textarea = sacSection.querySelector('textarea');
            if (textarea) {
                const sac = params.get('Sac');
                if (sac !== null) {
                    textarea.value = sac;
                }
            }
        }

        const ceintureSection = Array.from(document.querySelectorAll('.section'))
            .find(section => section.querySelector('h2')?.textContent === 'Ceinture/dos');
        if (ceintureSection) {
            const textarea = ceintureSection.querySelector('textarea');
            if (textarea) {
                const ceinture = params.get('Ceinture/dos');
                if (ceinture !== null) {
                    textarea.value = ceinture;
                }
            }
        }

        // Remplir les armes
        const armesSection = Array.from(document.querySelectorAll('.section'))
            .find(section => section.querySelector('h2')?.textContent === 'Armes');
        if (armesSection) {
            // Récupérer les armes depuis les paramètres d'URL si disponibles
            // Cette partie devrait être adaptée en fonction de comment les armes sont stockées dans l'URL
        }

        // Remplir les sorts
        const sortsSection = Array.from(document.querySelectorAll('.section'))
            .find(section => section.querySelector('h2')?.textContent.trim() === 'Sorts');
        if (sortsSection) {
            const inputs = sortsSection.querySelectorAll('input');
            // Cette partie devrait être adaptée en fonction de comment les sorts sont stockées dans l'URL
        }

        // Remplir les attaques spéciales
        const attaquesSection = Array.from(document.querySelectorAll('.section'))
            .find(section => section.querySelector('h2')?.textContent.trim() === 'Attaques Spéciales');
        if (attaquesSection) {
            const inputs = attaquesSection.querySelectorAll('input');
            // Cette partie devrait être adaptée en fonction de comment les attaques spéciales sont stockées dans l'URL
        }

        // Remplir les sorts mineurs
        const sortsMineurs = Array.from(document.querySelectorAll('.section'))
            .find(section => section.querySelector('h2')?.textContent.trim() === 'Sorts mineurs');
        if (sortsMineurs) {
            const inputs = sortsMineurs.querySelectorAll('input');
            // Cette partie devrait être adaptée en fonction de comment les sorts mineurs sont stockées dans l'URL
        }

        // Remplir les compétences de classe
        const competencesClasseSection = Array.from(document.querySelectorAll('.section'))
            .find(section => section.querySelector('h2')?.textContent.includes('Compétences de classe'));
        if (competencesClasseSection) {
            const rows = competencesClasseSection.querySelectorAll('tbody tr');
            // Cette partie devrait être adaptée en fonction de comment les compétences sont stockées dans l'URL
        }

        // Remplir les compétences spéciales du personnage
        const competencesSpecialesSection = Array.from(document.querySelectorAll('.section'))
            .find(section => section.querySelector('h2')?.textContent.includes('Compétences spéciales'));
        if (competencesSpecialesSection) {
            const textarea = competencesSpecialesSection.querySelector('textarea');
            if (textarea) {
                const competencesSpeciales = params.get('Compétences spéciales du personnage');
                if (competencesSpeciales !== null) {
                    textarea.value = competencesSpeciales;
                }
            }
        }

        // Remplir les choix de level up
        const levelUpSection = Array.from(document.querySelectorAll('.section'))
            .find(section => section.querySelector('h2')?.textContent.includes('Choix de level up'));
        if (levelUpSection) {
            const textarea = levelUpSection.querySelector('textarea');
            if (textarea) {
                const levelUp = params.get('Choix de level up et Effets permanents');
                if (levelUp !== null) {
                    textarea.value = levelUp;
                }
            }
        }

        // Gestionnaire d'événement pour le bouton de sauvegarde
        const saveButton = document.getElementById('save-data-btn');
        saveButton.addEventListener('click', async () => {
          console.log('Bouton Sauvegarder cliqué');
          if (!nom) {
            alert('Erreur : nom du joueur non trouvé');
            return;
          }

          // Récupérer les valeurs des tableaux de compétences de classe
          const competencesClasse = Array.from(document.querySelectorAll('.competences-table tbody tr')).map(row => {
            const inputs = row.querySelectorAll('input');
            return {
              nom: inputs[0].value,
              effets: inputs[1].value,
              niveau: inputs[2].value
            };
          }).filter(comp => comp.nom || comp.effets);

          // Récupérer les armes
          const armes = [];
          const armesTable = document.querySelector('.weapons-table tbody');
          if (armesTable) {
            const rows = armesTable.querySelectorAll('tr');
            rows.forEach(row => {
              const inputs = row.querySelectorAll('input');
              if (inputs[0].value) {
                armes.push({
                  type: inputs[0].value,
                  degats: inputs[1].value
                });
              }
            });
          }

          // Récupérer les sorts
          const sorts = [];
          const sortsSection = document.querySelector('.section h2[innerText="Sorts"]')?.closest('.section');
          if (sortsSection) {
            const fields = sortsSection.querySelectorAll('.field');
            for (let i = 0; i < fields.length; i += 3) {
              const nom = fields[i].querySelector('input')?.value;
              if (nom) {
                sorts.push({
                  nom: nom,
                  degats: fields[i+1].querySelector('input')?.value || '',
                  niveau: fields[i+2].querySelector('input')?.value || ''
                });
              }
            }
          }

          // Récupérer les sorts mineurs
          const sortsMineurs = [];
          const sortsMinSection = document.querySelector('.section h2[innerText="Sorts mineurs"]')?.closest('.section');
          if (sortsMinSection) {
            const fields = sortsMinSection.querySelectorAll('.field');
            for (let i = 0; i < fields.length; i += 2) {
              const nom = fields[i].querySelector('input')?.value;
              if (nom) {
                sortsMineurs.push({
                  nom: nom,
                  degats: fields[i+1].querySelector('input')?.value || ''
                });
              }
            }
          }

          // Récupérer les attaques spéciales
          const attaquesSpeciales = [];
          const attaquesSection = document.querySelector('.section h2[innerText="Attaques Spéciales"]')?.closest('.section');
          if (attaquesSection) {
            const fields = attaquesSection.querySelectorAll('.field');
            for (let i = 0; i < fields.length; i += 3) {
              const nom = fields[i].querySelector('input')?.value;
              if (nom) {
                attaquesSpeciales.push({
                  nom: nom,
                  degats: fields[i+1].querySelector('input')?.value || '',
                  niveau: fields[i+2].querySelector('input')?.value || ''
                });
              }
            }
          }

          // Récupérer la biographie
          const biographieSection = document.querySelector('.section h2[innerText="Biographie"]')?.closest('.section');
          const biographie = biographieSection?.querySelector('textarea')?.value || '';

          // Récupérer les compétences spéciales
          const competencesSpecialesSection = document.querySelector('.section h2[innerText="Compétences spéciales du personnage"]')?.closest('.section');
          const competencesSpeciales = competencesSpecialesSection?.querySelector('textarea')?.value || '';

          // Récupérer les choix de level up
          const levelUpSection = document.querySelector('.section h2[innerText="Choix de level up et Effets permanents"]')?.closest('.section');
          const levelUp = levelUpSection?.querySelector('textarea')?.value || '';

          // Récupérer le contenu du sac et de la ceinture/dos
          const sacSection = document.querySelector('.section h2[innerText="Sac"]')?.closest('.section');
          const sac = sacSection?.querySelector('textarea')?.value || '';

          const ceintureSection = document.querySelector('.section h2[innerText="Ceinture/dos"]')?.closest('.section');
          const ceinture = ceintureSection?.querySelector('textarea')?.value || '';

          // Construire l'objet de données à sauvegarder
          const nouvellesDonnees = {
            nom: nom,
            classe: document.getElementById('player_class').value,
            race: document.getElementById('player_race').value,
            niveau: getNumericValue('Niveau'),
            hp: {
              max: getNumericValue('Vie'),
              current: parseInt(params.get('VieCurrent')) || 0
            },
            mana: {
              max: getNumericValue('Mana'),
              current: parseInt(params.get('ManaCurrent')) || 0
            },
            stats: {
              force: getNumericValue('Force'),
              dexterite: getNumericValue('Dextérité'),
              magie: getNumericValue('Magie'),
              constitution: getNumericValue('Constitution'),
              charisme: getNumericValue('Charisme'),
              perception: getNumericValue('Perception'),
              chance: getNumericValue('Chance'),
              intelligence: getNumericValue('Intelligence')
            },
            equipement: {
              sac: sac,
              ceinture: ceinture,
              armes: armes,
              armure: document.getElementById('eq_armure').value,
              resistance: getFieldValue('Résistance'),
              durabilite: {
                max: getNumericValue('Durabilité'),
                current: parseInt(params.get('DuraCurrent')) || 0
              }
            },
            defense: {
              survie: getFieldValue('Jets de survie'),
              bonus_vie: getNumericValue('Vie bonus'),
              protection: {
                max: parseInt(document.getElementById('Valeur protection').value),
                current: parseInt(document.getElementById('ProtectionCurrent').value)
              },
              intox: getNumericValue('Intox.')
            },
            competences: {
              classe: competencesClasse,
              sorts: sorts,
              sorts_mineurs: sortsMineurs,
              attaques_speciales: attaquesSpeciales,
              speciales: competencesSpeciales
            },
            bio: biographie,
            levelup: levelUp
          };

          try {
            console.log('Données à sauvegarder:', { nom: nom, nouvellesDonnees });
            const response = await fetch('/api/joueur', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ nom: nom, nouvellesDonnees })
            });

            if (response.ok) {
              // Mettre à jour l'URL avec les nouvelles valeurs
              const newParams = new URLSearchParams();
              
              // Mise à jour des paramètres généraux
              newParams.set('Nom', nom);
              newParams.set('Classe', nouvellesDonnees.classe);
              newParams.set('Race', nouvellesDonnees.race);
              newParams.set('Niveau', nouvellesDonnees.niveau);
              
              // Mise à jour HP/Mana
              newParams.set('VieMax', nouvellesDonnees.hp.max);
              newParams.set('VieCurrent', nouvellesDonnees.hp.current);
              newParams.set('ManaMax', nouvellesDonnees.mana.max);
              newParams.set('ManaCurrent', nouvellesDonnees.mana.current);
              
              // Mise à jour des stats
              newParams.set('Force', nouvellesDonnees.stats.force);
              newParams.set('Dextérité', nouvellesDonnees.stats.dexterite);
              newParams.set('Magie', nouvellesDonnees.stats.magie);
              newParams.set('Constitution', nouvellesDonnees.stats.constitution);
              newParams.set('Charisme', nouvellesDonnees.stats.charisme);
              newParams.set('Perception', nouvellesDonnees.stats.perception);
              newParams.set('Chance', nouvellesDonnees.stats.chance);
              newParams.set('Intelligence', nouvellesDonnees.stats.intelligence);
              
              // Mise à jour de la défense
              newParams.set('Jets de survie', nouvellesDonnees.defense.survie);
              newParams.set('Vie bonus', nouvellesDonnees.defense.bonus_vie);
              newParams.set('ProtectionMax', nouvellesDonnees.defense.protection);
              newParams.set('ProtectionCurrent', nouvellesDonnees.defense.protection);
              newParams.set('Intox.', nouvellesDonnees.defense.intox);
              
              // Mise à jour de l'équipement
              newParams.set('Sac', nouvellesDonnees.equipement.sac);
              newParams.set('Ceinture/dos', nouvellesDonnees.equipement.ceinture);
              newParams.set("Type d'armure", nouvellesDonnees.equipement.armure);
              newParams.set('Résistance', nouvellesDonnees.equipement.resistance);
              newParams.set('DuraMax', nouvellesDonnees.equipement.durabilite?.max);
              newParams.set('DuraCurrent', nouvellesDonnees.equipement.durabilite?.current);
              
              // Mise à jour des compétences et autres
              newParams.set('Compétences spéciales du personnage', nouvellesDonnees.competences.speciales);
              newParams.set('Biographie', nouvellesDonnees.bio);
              newParams.set('Choix de level up et Effets permanents', nouvellesDonnees.levelup);
              
              // Mettre à jour l'URL sans recharger la page
              window.history.pushState({}, '', `${window.location.pathname}?${newParams.toString()}`);
              console.log('URL mise à jour avec les nouvelles valeurs');
              alert('Données sauvegardées avec succès !');
            } else {
              const error = await response.text();
              throw new Error(error);
            }
          } catch (error) {
            console.error('Erreur de sauvegarde:', error);
            alert('Une erreur est survenue lors de la sauvegarde: ' + error.message);
          }   
        });   
      });     

      // Fonction pour mettre à jour l'état de l'armure
      function updateArmorState() {
        const durabilite = document.querySelector('.field input[type="number"][label="Durabilité"]')?.value || 0;
        const armorStateInput = document.getElementById('player_armor');
        const armorStateEffect = document.getElementById('armor_effect');

        if (!armorStateInput || !armorStateEffect) return;

        const duraMax = parseInt(durabilite) || 0;
        const duraCurrent = parseInt(document.querySelector('.field input[name="durabilite_current"]')?.value) || 0;

        let etat = '';
        let couleur = '';
        let effect = '';

        if (duraCurrent === 0) {
          etat = "Absence d'armure";
          couleur = '#000000';
          effect = 'Plus aucune protection';
        } else if (duraCurrent >= ((duraMax/3)*2)+1) {
          etat = 'Armure Neuve';
          couleur = '#2e7d32';
          effect = 'Protection maximale';
        } else if (duraCurrent >= (duraMax/3)+1) {
          etat = 'Armure Abîmée';
          couleur = '#ff9800';
          effect = 'Bonus fixe supprimé';
        } else {
          etat = 'Armure Très Abîmée';
          couleur = '#d32f2f';
          effect = 'Résultat du jet réduite de moitié';
        }
        
        armorStateInput.value = etat;
        armorStateInput.style.color = couleur;
        armorStateEffect.textContent = effect;
        armorStateEffect.style.color = couleur;
      }

      // Après le chargement de la page
      document.addEventListener('DOMContentLoaded', async () => {
          // Fonction pour créer une nouvelle ligne de sort
          async function createSortRow(isMajeur = true) {
              try {
                  const response = await fetch('/api/game-database');
                  if (!response.ok) throw new Error('Erreur de chargement des sorts');
                  const gameData = await response.json();
                  
                  const sortRow = document.createElement('div');
                  sortRow.className = 'sort-row';
                  
                  // Select pour le nom du sort
                  const selectSort = document.createElement('select');
                  selectSort.className = 'sort-select';
                  
                  // Récupérer la liste des sorts depuis la base de données
                  const sorts = isMajeur ? gameData.sorts_majeurs : gameData.sorts_mineurs;
                  
                  // Option par défaut
                  selectSort.innerHTML = '<option value="">Sélectionner un sort</option>';
                  
                  // Ajouter les options de sorts
                  sorts.forEach(sort => {
                      const option = document.createElement('option');
                      option.value = sort.id;
                      option.textContent = sort.nom;
                      option.dataset.degats = sort.degats;
                      option.dataset.niveau = sort.niveau;
                      selectSort.appendChild(option);
                  });

                  // Champs pour les dégâts et le niveau
                  const degatsInput = document.createElement('input');
                  degatsInput.type = 'text';
                  degatsInput.readOnly = true;
                  
                  const niveauInput = document.createElement('input');
                  niveauInput.type = 'number';
                  niveauInput.readOnly = true;

                  // Événement de changement du sort
                  selectSort.addEventListener('change', (e) => {
                      const selectedOption = e.target.options[e.target.selectedIndex];
                      degatsInput.value = selectedOption.dataset.degats || '';
                      niveauInput.value = selectedOption.dataset.niveau || '';
                  });

                  // Ajouter les éléments à la ligne
                  sortRow.appendChild(selectSort);
                  sortRow.appendChild(degatsInput);
                  if (isMajeur) {
                      sortRow.appendChild(niveauInput);
                  }

                  return sortRow;
              } catch (error) {
                  console.error('Erreur:', error);
                  alert('Erreur lors du chargement des sorts');
              }
          }

          // Gestionnaire pour le bouton d'ajout de sort majeur
          document.getElementById('add-sort-btn').addEventListener('click', async () => {
              const container = document.getElementById('sorts-container');
              const sortRow = await createSortRow(true);
              container.appendChild(sortRow);
          });

          // Gestionnaire pour le bouton d'ajout de sort mineur
          document.getElementById('add-sort-mineur-btn').addEventListener('click', async () => {
              const container = document.getElementById('sorts-mineurs-container');
              const sortRow = await createSortRow(false);
              container.appendChild(sortRow);
          });
      });
  </script>
</body>
</html>