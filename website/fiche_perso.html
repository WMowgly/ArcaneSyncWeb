<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Fiche de Personnage</title>
  <link href="https://fonts.googleapis.com/css2?family=Uncial+Antiqua&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css"/> 
  <style>
    body {
      font-family: 'Uncial Antiqua', cursive;
      background-size: cover;
      background-color: #fdf6e3;
      color: #3b2f1e;
      margin: 0;
      padding: 40px;
    }

    h1, h2 {
      text-align: center;
      text-shadow: 1px 1px 2px #00000050;
    }

    .section {
      position: relative;
      background: rgba(255, 248, 220, 0.9);
      border: 4px solid #8b5e3c;
      border-radius: 12px;
      padding: 50px 20px 20px 20px;
      margin-bottom: 30px;
      box-shadow: 0 0 10px #3b2f1e99;
      overflow: hidden;
    }

    .section h2 {
      position: absolute;
      top: -20px;
      left: 20px;
      background: rgba(255, 248, 220, 0.95);
      padding: 0 10px;
      font-size: 20px;
      color: #5c3b21;
      border: 2px solid #8b5e3c;
      border-radius: 8px;
      box-shadow: 2px 2px 4px #00000040;
      z-index: 2;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 15px;
    }

    .grid-3 {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
    }

    .field {
      display: flex;
      flex-direction: column;
    }

    label {
      font-weight: bold;
      margin-bottom: 5px;
      color: #3b2f1e;
    }

    input, textarea {
      font-family: 'Uncial Antiqua', cursive;
      padding: 6px 10px;
      font-size: 16px;
      background: #fefae0;
      border: 2px solid #8b5e3c;
      border-radius: 6px;
      box-shadow: inset 0 0 4px #8b5e3c44;
      box-sizing: border-box;
      width: 100%;
    }

    textarea {
      resize: vertical;
      height: 150px;
    }

    #save-data-btn {
      font-family: 'Uncial Antiqua', cursive;
      padding: 10px 30px;
      font-size: 18px;
      background: #8b5e3c;
      color: #fefae0;
      border: 2px solid #5c3b21;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 2px 2px 4px #3b2f1e66;
      transition: all 0.3s ease;
      margin: 20px 0;
    }

    #save-data-btn:hover {
      background: #5c3b21;
      transform: translateY(-2px);
      box-shadow: 3px 3px 6px #3b2f1e88;
    }

    #save-data-btn:active {
      transform: translateY(0);
      box-shadow: 1px 1px 3px #3b2f1e44;
    }

    .competences-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    .competences-table th, .competences-table td {
      border: 1px solid #8b5e3c;
      padding: 8px;
      text-align: left;
    }

    .competences-table th {
      background-color: rgba(139, 94, 60, 0.2);
    }

    .spells-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
    }

    .spell-item {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 5px;
      margin-bottom: 10px;
    }

    .spell-item label {
      grid-column: 1 / -1;
      margin-bottom: 0;
    }

    @media (max-width: 768px) {
      .grid, .grid-3 {
        grid-template-columns: repeat(2, 1fr);
      }
      .spells-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 480px) {
      .grid, .grid-3 {
        grid-template-columns: 1fr;
      }
    }

    select {
      font-family: 'Uncial Antiqua', cursive;
      padding: 6px 10px;
      font-size: 16px;
      background: #fefae0;
      border: 2px solid #8b5e3c;
      border-radius: 6px;
      box-shadow: inset 0 0 4px #8b5e3c44;
      box-sizing: border-box;
      width: 100%;
      color: #3b2f1e;
      cursor: pointer;
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%238b5e3c' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 10px center;
      background-size: 16px;
      padding-right: 30px;
    }

    select:hover {
      border-color: #5c3b21;
      background-color: #fff8dc;
    }

    select:focus {
      outline: none;
      border-color: #5c3b21;
      box-shadow: 0 0 0 2px #8b5e3c33;
    }

    select option {
      background: #fefae0;
      color: #3b2f1e;
      padding: 8px;
    }

    .header-fields {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 15px;
      margin-bottom: 20px;
    }

    .niveau-race {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 10px;
    }

    .double-section-container {
        display: flex;
        gap: 30px;
        margin-bottom: 30px;
    }

    .double-section-container .section {
        flex: 1;
    }

    .sort-row {
      background: rgba(139, 94, 60, 0.1);
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 8px;
      display: grid;
      grid-template-columns: 2fr 1fr 1fr;
      gap: 10px;
      align-items: center;
    }

    .add-btn {
      font-family: 'Uncial Antiqua', cursive;
      background: #8b5e3c;
      color: #fefae0;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 10px;
    }

    .add-btn:hover {
      background: #5c3b21;
    }

    .dual-input {
    display: flex;
    align-items: center;
    gap: 5px;
  }

  .dual-input input {
    flex: 1;
    min-width: 0;
  }

  .divider-span {
    color: #8b5e3c;
    font-weight: bold;
    padding: 0 5px;
  }

  .status-text {
    margin-top: 5px;
    font-size: 0.9em;
    font-style: italic;
  }

  #player_armor {
    font-weight: bold;
  }
  
  .sort-row {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr auto;  /* Modifié pour ajouter une colonne pour le bouton */
    gap: 10px;
    align-items: center;
  }

  .delete-btn {
    font-family: 'Uncial Antiqua', cursive;
    background: #d32f2f;
    color: #fefae0;
    border: none;
    padding: 4px 8px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
  }

  .delete-btn:hover {
    background: #b71c1c;
  }

  .description-btn {
    font-family: 'Uncial Antiqua', cursive;
    background: #8b5e3c;
    color: #fefae0;
    border: none;
    padding: 2px 6px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    margin-left: 8px;
  }

  .description-btn:hover {
    background: #5c3b21;
  }

  .description-content {
    display: none;
    margin-top: 8px;
    padding: 8px;
    background: rgba(139, 94, 60, 0.1);
    border-radius: 4px;
    font-size: 0.9em;
    grid-column: 1 / -1;
  }

  .description-content.visible {
    display: block;
  }
  </style>
</head>
<body>
  <div id="navbar-placeholder"></div>
  <h1>Fiche de Personnage</h1>

  <div class="section">
    <h2>Informations Générales</h2>
    <div class="grid">
      <div class="field"><label>Nom</label><input type="text" id="player_name"></div>
      <div class="field"><label>Classe</label><select id="player_class"></select></div>
      <div class="field"><label>Race</label><select id="player_race"></select></div>
      <div class="field"><label>Niveau</label><input type="number" id="player_level" min="1"></div>
    </div>
  </div>

  <div class="section">
    <h2>Statistiques</h2>
    <div class="grid">
      <div class="field"><label>Force</label><input type="number" id="stat_force"></div>
      <div class="field"><label>Dexterite</label><input type="number" id="stat_dexterite"></div>
      <div class="field"><label>Magie</label><input type="number" id="stat_magie"></div>
      <div class="field"><label>Constitution</label><input type="number" id="stat_constitution"></div>
      <div class="field"><label>Charisme</label><input type="number" id="stat_charisme"></div>
      <div class="field"><label>Perception</label><input type="number" id="stat_perception"></div>
      <div class="field"><label>Chance</label><input type="number" id="stat_chance"></div>
      <div class="field"><label>Intelligence</label><input type="number" id="stat_intelligence"></div>
    </div>
  </div>

  <div class="section">
    <h2>Survie et Défense</h2>
    <div class="grid">
        <div class="field">
        <label>Vie</label>
        <div class="dual-input">
          <input type="number" id="player_hp_current" min="0" placeholder="Min">
          <span class="divider-span">/</span>
          <input type="number" id="player_hp">
        </div>
      </div>

      <div class="field">
        <label>Mana</label>
        <div class="dual-input">
          <input type="number" id="player_mana_current" min="0" placeholder="Min">
          <span class="divider-span">/</span>
          <input type="number" id="player_mana">
        </div>
      </div>

        <div style="display: flex; flex-direction: column;">
          <label>Vie bonus</label>
          <input type="number" id="player_vie_bonus" min="0" placeholder="0">
        </div>
        <div style="display: flex; flex-direction: column;">
          <label>Intox.</label>
          <input type="number" id="player_intox" placeholder="0" min="0" max="100">
        </div>

    </div><!-- fin du grid -->
  </div>

    <div class="sections-container">
        <!-- Section Sac -->
        <div class="section">
            <h2>Sac</h2>
            <div class="content-area">
                <textarea id="eq_sac"></textarea>
            </div>
        </div>
    
        <!-- Section Ceinture/dos -->
        <div class="section">
            <h2>Ceinture/dos</h2>
            <div class="content-area">
                <textarea id="eq_ceinture"></textarea>
            </div>
        </div>
    
        <!-- Section Armes -->
        <div class="section">
            <h2>Armes</h2>
            <table class="weapons-table">
                <thead>
                    <tr>
                        <th>Type</th>
                        <th>Dégâts</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><input type="text" id="weapon_type_1"></td>
                        <td><input type="text" id="weapon_dmg_1"></td>
                    </tr>
                    <tr>
                        <td><input type="text" id="weapon_type_2"></td>
                        <td><input type="text" id="weapon_dmg_2"></td>
                    </tr>
                    <tr>
                        <td><input type="text" id="weapon_type_3"></td>
                        <td><input type="text" id="weapon_dmg_3"></td>
                    </tr>
                    <tr>
                        <td><input type="text" id="weapon_type_4"></td>
                        <td><input type="text" id="weapon_dmg_4"></td>
                    </tr>
                    <tr>
                        <td><input type="text" id="weapon_type_5"></td>
                        <td><input type="text" id="weapon_dmg_5"></td>
                    </tr>
                </tbody>
            </table>
        </div>
    
        <!-- Section Armure -->
        <div class="section">
            <h2>Armure</h2>
            <div class="armor-section">
                <div class="armor-fields">
                    <div class="field"><label>Type d'armure</label><select id="eq_armure"></select></div>
                    <div class="field"><label>Résistance</label><input type="text" id="eq_resistance"></div>
                    <div class="field">
                      <label>Durabilité</label>
                      <div class="dual-input">
                        <input type="number" id="player_dura_current" min="0" placeholder="0">
                        <span class="divider-span">/</span>
                        <input type="number" id="player_dura_max" placeholder="Max">
                      </div>
                    </div>
      
                    <div class="field">
                      <label>État de l'armure</label>
                      <input type="text" id="player_armor" readonly>
                      <div id="armor_effect" class="status-text"></div>
                    </div>
                    <div class="field">
                      <label>Valeur de Protection</label>
                      <div class="dual-input">
                        <input type="number" id="def_protection" min="0" placeholder="0">
                        <span class="divider-span">/</span>
                        <input type="number" id="def_protection_max" placeholder="Max">
                      </div>
                    </div>
                  </div>
            </div>
        </div>
    </div>


    <div class="double-section-container">
        <div class="section">
            <h2>Sorts</h2>
            <div id="sorts-container">
                <!-- Les sorts seront ajoutés ici dynamiquement -->
            </div>
            <button type="button" class="add-btn" id="add-sort-btn">Ajouter un sort</button>
        </div>
            
        <div class="section">
            <h2>Attaques Spéciales</h2>
            <div id="attack-special-container">
                <!-- Les attaques seront ajoutées ici dynamiquement -->
            </div>
            <button type="button" class="add-btn" id="add-attack-spe-btn">Ajouter une attaque</button>
        </div>
    </div>

    <div class="section">
        <h2>Sorts mineurs</h2>
        <div id="sorts-mineurs-container">
            <!-- Les sorts mineurs seront ajoutés ici dynamiquement -->
        </div>
        <button type="button" class="add-btn" id="add-sort-mineur-btn">Ajouter un sort mineur</button>
    </div>

  <div class="section">
  <h2>Compétences de classe et passifs</h2>
  <div id="competences-passives-container">
    <table class="competences-table">
      <thead>
        <tr>
          <th>Nom</th>
          <th>Effets</th>
          <th>Niveau</th>
        </tr>
      </thead>
      <tbody>
        <!-- Les compétences seront ajoutées ici dynamiquement -->
      </tbody>
    </table>
  </div>
</div>

  <div class="section">
    <h2>Compétences spéciales du personnage</h2>
    <div class="field">
      <textarea id="skills_speciales"></textarea>
    </div>
  </div>

  <div class="section">
    <h2>Biographie</h2>
    <div class="field">
      <textarea id="bio"></textarea>
    </div>
  </div>

  <div class="section">
    <h2>Choix de level up et Effets permanents</h2>
    <div class="field">
      <textarea id="levelup"></textarea>
    </div>
  </div>

  <div style="text-align: center;">
    <button id="save-data-btn" type="button" onclick="console.log('Clic direct')">Sauvegarder</button>
  </div>

  <script src="navbar.js"></script>
  <script>
    function getFieldValue(selector, defaultValue = '') {
      const element = document.querySelector(selector);
      return element ? element.value || defaultValue : defaultValue;
    }

    function getNumericValue(selector, defaultValue = 0) {
      const value = getFieldValue(selector);
      return parseInt(value) || defaultValue;
    }
    // Options de sélection
      const options = {
        "classes": ["Guerrier", "Paladin", "Mage", "Marchand", "Ranger", "Druide", "Aventurier", "Sorceleur"],
        "races": ["Humain", "Nain", "Elfe", "Draconnir", "Demi-Elfe", "Humnigar", "Ecorfal"],
        "armures": ["Armure légère", "Armure moyenne", "Armure lourde"]
      };

      // Remplir la liste déroulante des classes
      const classSelect = document.getElementById('player_class');
      options.classes.forEach(className => {
        const option = document.createElement('option');
        option.value = className;
        option.textContent = className;
        classSelect.appendChild(option);
      });

      // Remplir la liste déroulante des races
      const raceSelect = document.getElementById('player_race');
      options.races.forEach(raceName => {
        const option = document.createElement('option');
        option.value = raceName;
        option.textContent = raceName;
        raceSelect.appendChild(option);
      });

      // Remplir la liste déroulante des armures
      const armorSelect = document.getElementById('eq_armure');
      options.armures.forEach(armorName => {
        const option = document.createElement('option');
        option.value = armorName;
        option.textContent = armorName;
        armorSelect.appendChild(option);
      });
      
      // Fonction pour remplir les champs
      function fillField(id, value) {
        const element = document.getElementById(id);
        if (element) {
          if (element.tagName === 'SELECT') {
            // Pour les listes déroulantes, sélectionner la bonne option
            for (let option of element.options) {
              if (option.value === value) {
                option.selected = true;
                break;
              }
            }
          } else {
            // Pour les autres types de champs
            element.value = value;
          }
        } else {
          console.warn(`Élément avec l'ID ${id} non trouvé`);
        }
      }

window.addEventListener('DOMContentLoaded', async () => {  // Ajout du mot-clé async ici
  const params = new URLSearchParams(window.location.search);
  
  // Fonction utilitaire pour récupérer les valeurs des paramètres
  function getParamValue(key, defaultValue = '') {
    const value = params.get(key);
    if (!value || value === 'null' || value === 'undefined') return defaultValue;
    try {
      return decodeURIComponent(value);
    } catch {
      return defaultValue;
    }
  }

  // Remplir les champs avec les valeurs de l'URL
  fillField('player_name', getParamValue('Nom'));
  fillField('player_class', getParamValue('Classe'));
  fillField('player_race', getParamValue('Race'));
  fillField('player_level', getParamValue('Niveau', '1'));
  
  // Stats vitales
  fillField('player_hp', getParamValue('VieMax', '0'));
  fillField('player_hp_current', getParamValue('VieCurrent', '0'));
  fillField('player_mana', getParamValue('ManaMax', '0'));
  fillField('player_mana_current', getParamValue('ManaCurrent', '0'));
  
  // Protection et armure
  fillField('def_protection_max', getParamValue('Valeur protection max', '0'));
  fillField('def_protection', getParamValue('Valeur protection', '0'));
  fillField('player_dura_max', getParamValue('DuraMax', '0'));
  fillField('player_dura_current', getParamValue('DuraCurrent', '0'));
  fillField('eq_armure', getParamValue("Type d'armure", ''));
  fillField('eq_resistance', getParamValue('Résistance', ''));
  fillField('player_vie_bonus', getParamValue('Vie bonus', '0'));
  fillField('player_intox', getParamValue('Intox.', '0'));

  // Stats de base
  fillField('stat_force', getParamValue('Force', '0'));
  fillField('stat_dexterite', getParamValue('Dexterite', '0'));
  fillField('stat_magie', getParamValue('Magie', '0'));
  fillField('stat_constitution', getParamValue('Constitution', '0'));
  fillField('stat_charisme', getParamValue('Charisme', '0'));
  fillField('stat_perception', getParamValue('Perception', '0'));
  fillField('stat_chance', getParamValue('Chance', '0'));
  fillField('stat_intelligence', getParamValue('Intelligence', '0'));

  // Inventaire
  fillField('eq_sac', getParamValue('Sac', ''));
  fillField('eq_ceinture', getParamValue('Ceinture / Dos', ''));

  // Remplir les champs supplémentaires
  fillField('bio', getParamValue('Biographie', ''));
  fillField('skills_speciales', getParamValue('Skills speciales', ''));
  fillField('levelup', getParamValue('Choix de level up', ''));

  // Gestion des compétences de classe et passifs
  try {
    const competencesPassivesContainer = document.querySelector('#competences-passives-container tbody');
    competencesPassivesContainer.innerHTML = ''; // Nettoie le conteneur
    
    const selectedClass = document.getElementById('player_class').value;
    const response = await fetch('/api/game-database');
    const gameData = await response.json();
    const competencesClasse = gameData.competences_classes[selectedClass] || [];
    
    competencesClasse.forEach(comp => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td><input type="text" value="${comp.nom}" class="comp_name" readonly></td>
        <td><input type="text" value="${comp.effet}" class="comp_effet" readonly></td>
        <td><input type="number" value="${comp.niveau}" class="comp_niveau" readonly></td>
      `;
      competencesPassivesContainer.appendChild(row);
    });
  } catch (error) {
    console.error('Erreur lors du chargement des compétences passives:', error);
  }

  // Ajouter le gestionnaire d'événement pour le changement de classe
  document.getElementById('player_class').addEventListener('change', async function() {
    const selectedClass = this.value;
    const competencesPassivesContainer = document.querySelector('#competences-passives-container tbody');
    competencesPassivesContainer.innerHTML = ''; // Nettoie le conteneur

    try {
      const response = await fetch('/api/game-database');
      const gameData = await response.json();
      const competencesClasse = gameData.competences_classes[selectedClass] || [];
      
      competencesClasse.forEach(comp => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td><input type="text" value="${comp.nom}" class="comp_name" readonly></td>
          <td><input type="text" value="${comp.effet}" class="comp_effet" readonly></td>
          <td><input type="number" value="${comp.niveau}" class="comp_niveau" readonly></td>
        `;
        competencesPassivesContainer.appendChild(row);
      });
    } catch (error) {
      console.error('Erreur lors du chargement des compétences:', error);
    }
  });

  // Gestion des sorts majeurs
  try {
    if (params.get('Sorts')) {
      const sortsContainer = document.getElementById('sorts-container');
      sortsContainer.innerHTML = ''; // Nettoie le conteneur
      const sorts = JSON.parse(getParamValue('Sorts', '[]'));
      sorts.forEach(sort => {
        createSortElement(sort, sortsContainer, false);
      });
    }
  } catch (error) {
    console.error('Erreur lors du chargement des sorts:', error);
  }

  // Gestion des attaques spéciales
  try {
    if (params.get('Attaques speciales')) {
      const attacksContainer = document.getElementById('attack-special-container');
      attacksContainer.innerHTML = ''; // Nettoie le conteneur
      const attacks = JSON.parse(getParamValue('Attaques speciales', '[]'));
      console.log('Chargement des attaques spéciales:', attacks); // Debug
      for (const attack of attacks) {
        const attackRow = await createAttackElement(attack);
        if (attackRow) {
          attacksContainer.appendChild(attackRow);
        }
      }
    }
  } catch (error) {
    console.error('Erreur lors du chargement des attaques spéciales:', error);
  }

  // Gestion des sorts mineurs
  try {
    if (params.get('Sorts mineurs')) {
      const sortsMineursContainer = document.getElementById('sorts-mineurs-container');
      sortsMineursContainer.innerHTML = ''; // Nettoie le conteneur
      const sortsMineurs = JSON.parse(getParamValue('Sorts mineurs', '[]'));
      sortsMineurs.forEach(sort => {
        createSortElement(sort, sortsMineursContainer, true);
      });
    }
  } catch (error) {
    console.error('Erreur lors du chargement des sorts mineurs:', error);
  }

  // Gestion des armes (déjà présent mais modifié pour plus de robustesse)
  try {
    if (params.get('Armes')) {
      const armes = JSON.parse(getParamValue('Armes', '[]'));
      armes.forEach((arme, index) => {
        if (index < 5) {
          fillField(`weapon_type_${index + 1}`, arme.type || '');
          fillField(`weapon_dmg_${index + 1}`, arme.degats || '');
        }
      });
    }
  } catch (error) {
    console.error('Erreur lors du chargement des armes:', error);
  }

  // Ajout des logs pour le débogage
  console.log('Chargement des données terminé');
  console.log('Compétences spéciales:', getParamValue('Skills speciales'));
  console.log('Biographie:', getParamValue('Biographie'));
  console.log('Level up:', getParamValue('Choix de level up'));
  
  // Gestionnaire de sauvegarde
  document.getElementById('save-data-btn').addEventListener('click', async () => {
    
    try {
    const nom = document.getElementById('player_name').value;
    if (!nom) {
      throw new Error('Le nom du joueur est requis');
    }

    // Collecte des sorts majeurs
    const spells = [];
    document.querySelectorAll('#sorts-container .sort-row').forEach((row, index) => {
      const nom = row.querySelector('.spell_name')?.value;
      if (nom) {
        spells.push({
          nom: nom,
          degats: row.querySelector('.spell_dmg')?.value || '',
          niveau: parseInt(row.querySelector('.spell_lvl')?.value) || 1
        });
      }
    });

    // Collecte des sorts mineurs
    const sortsMineurs = [];
    document.querySelectorAll('#sorts-mineurs-container .sort-row').forEach((row, index) => {
      const nom = row.querySelector('.minispell_name')?.value;
      if (nom) {
        sortsMineurs.push({
          nom: nom,
          degats: row.querySelector('.minispell_dmg')?.value || ''
        });
      }
    });

    // Collecte des attaques spéciales
    const attaquesSpeciales = [];
    document.querySelectorAll('#attacks-container .sort-row').forEach((row, index) => {
      const nom = row.querySelector('.attack_name')?.value;
      if (nom) {
        attaquesSpeciales.push({
          nom: nom,
          degats: row.querySelector('.attack_dmg')?.value || '',
          niveau: parseInt(row.querySelector('.attack_lvl')?.value) || 1
        });
      }
    });

    // Construction des données à sauvegarder
    const donnees = {
      nom: document.getElementById('player_name').value,
      classe: document.getElementById('player_class').value,
      race: document.getElementById('player_race').value,
      niveau: parseInt(document.getElementById('player_level').value) || 1,
      stats: {
          force: parseInt(document.getElementById('stat_force').value) || 0,
          dexterite: parseInt(document.getElementById('stat_dexterite').value) || 0,
          magie: parseInt(document.getElementById('stat_magie').value) || 0,
          constitution: parseInt(document.getElementById('stat_constitution').value) || 0,
          charisme: parseInt(document.getElementById('stat_charisme').value) || 0,
          perception: parseInt(document.getElementById('stat_perception').value) || 0,
          chance: parseInt(document.getElementById('stat_chance').value) || 0,
          intelligence: parseInt(document.getElementById('stat_intelligence').value) || 0
      },
      bio: document.getElementById('bio').value || '',
      sac: document.getElementById('eq_sac').value || '',
      ceinture: document.getElementById('eq_ceinture').value || '',
      armure: {
          type: document.getElementById('eq_armure').value,
          resistance: document.getElementById('eq_resistance').value,
          durabilite: {
              max: parseInt(document.getElementById('player_dura_max').value) || 0,
              current: parseInt(document.getElementById('player_dura_current').value) || 0
          },
          protection: {
              max: parseInt(document.getElementById('def_protection_max').value) || 0,
              current: parseInt(document.getElementById('def_protection').value) || 0
          }
      },
      hp: {
          max: parseInt(document.getElementById('player_hp').value) || 0,
          current: parseInt(document.getElementById('player_hp_current').value) || 0
      },
      mana: {
          max: parseInt(document.getElementById('player_mana').value) || 0,
          current: parseInt(document.getElementById('player_mana_current').value) || 0
      },
      bonus_vie: parseInt(document.getElementById('player_vie_bonus').value) || 0,
      intox: document.getElementById('player_intox').value || '0',
      spells: getSpells(),
      sorts_mineurs: getSortsMineurs(),
      competences: getCompetences(),
      skills_speciales: document.getElementById('skills_speciales').value || '',
      levelup: document.getElementById('levelup').value || '',
      armes: getArmes(),
      attaques_speciales: getSpecialAttacks()
  };

    console.log('Données à envoyer:', donnees);

    const response = await fetch('/api/joueur', { 
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        nom: donnees.nom,              // Format attendu par l'API
        nouvellesDonnees: donnees     // Format attendu par l'API
      })
    });

    if (!response.ok) throw new Error(`Erreur HTTP: ${response.status}`);

    const result = await response.json();
    console.log('Sauvegarde réussie:', result);
    alert('Données sauvegardées avec succès !');

    // Construire la nouvelle URL avec le nom du personnage
    const urlParams = new URLSearchParams();
      urlParams.set('Nom', donnees.nom);
      urlParams.set('Classe', donnees.classe);
      urlParams.set('Race', donnees.race);
      urlParams.set('Niveau', donnees.niveau.toString());
      urlParams.set('VieMax', donnees.hp.max.toString());
      urlParams.set('VieCurrent', donnees.hp.current.toString());
      urlParams.set('ManaMax', donnees.mana.max.toString());
      urlParams.set('ManaCurrent', donnees.mana.current.toString());
      urlParams.set('Vie bonus', donnees.bonus_vie.toString());
      urlParams.set('Valeur protection', donnees.armure.protection.current.toString());
      urlParams.set('Valeur protection max', donnees.armure.protection.max.toString());
      urlParams.set('DuraMax', donnees.armure.durabilite.max.toString());
      urlParams.set('DuraCurrent', donnees.armure.durabilite.current.toString());
      urlParams.set("Type d'armure", donnees.armure.type);
      urlParams.set('Résistance', donnees.armure.resistance);
      urlParams.set('Intox.', donnees.intox);

      // Stats
      urlParams.set('Force', donnees.stats.force.toString());
      urlParams.set('Dexterite', donnees.stats.dexterite.toString());
      urlParams.set('Magie', donnees.stats.magie.toString());
      urlParams.set('Constitution', donnees.stats.constitution.toString());
      urlParams.set('Charisme', donnees.stats.charisme.toString());
      urlParams.set('Perception', donnees.stats.perception.toString());
      urlParams.set('Chance', donnees.stats.chance.toString());
      urlParams.set('Intelligence', donnees.stats.intelligence.toString());

      // Inventaire
      urlParams.set('Sac', donnees.sac);
      urlParams.set('Ceinture / Dos', donnees.ceinture);

      // Sorts et compétences
      urlParams.set('Sorts', JSON.stringify(donnees.spells));
      urlParams.set('Sorts mineurs', JSON.stringify(donnees.sorts_mineurs));
      urlParams.set('Competences', JSON.stringify(donnees.competences));
      urlParams.set('Armes', JSON.stringify(donnees.armes));
      urlParams.set('Attaques speciales', JSON.stringify(donnees.attaques_speciales));

      // Autres
      urlParams.set('Skills speciales', donnees.skills_speciales);
      urlParams.set('Biographie', donnees.bio);
      urlParams.set('Choix de level up', donnees.levelup);

      const newUrl = `${window.location.pathname}?${urlParams.toString()}`;
        
    // Mettre à jour l'URL et recharger la page
    window.location.href = newUrl;

  } catch (error) {
      console.error('Erreur lors de la sauvegarde:', error);
    alert(`Erreur lors de la sauvegarde: ${error.message}`);
    }
  });
});

// Ajouter ces fonctions utilitaires
function getSpells() {
  const spells = [];
  document.querySelectorAll('#sorts-container .sort-row').forEach(row => {
    const nom = row.querySelector('.spell_name')?.value;
    if (nom) {
      spells.push({
        nom: nom,
        degats: row.querySelector('.spell_dmg')?.value || '',
        niveau: parseInt(row.querySelector('.spell_lvl')?.value) || 1
      });
    }
  });
  return spells;
}

function getSortsMineurs() {
  const sortsMineurs = [];
  document.querySelectorAll('#sorts-mineurs-container .sort-row').forEach(row => {
    const nom = row.querySelector('.minispell_name')?.value;
    if (nom) {
      sortsMineurs.push({
        nom: nom,
        degats: row.querySelector('.minispell_dmg')?.value || ''
      });
    }
  });
  return sortsMineurs;
}

function getSpecialAttacks() {
  const attacks = [];
  document.querySelectorAll('#attack-special-container .sort-row').forEach(row => {
    const nom = row.querySelector('.attack_name')?.value;
    if (nom) {
      attacks.push({
        nom: nom,
        degats: row.querySelector('.attack_dmg')?.value || '',
        niveau: parseInt(row.querySelector('.attack_lvl')?.value) || 1
      });
    }
  });
  console.log('Attaques spéciales récupérées:', attacks);
  return attacks;
}

function getCompetences() {
  const competences = [];
  const table = document.querySelector('.competences-table tbody');
  if (table) {
    table.querySelectorAll('tr').forEach(row => {
      const inputs = row.querySelectorAll('input');
      if (inputs[0].value) {
        competences.push({
          nom: inputs[0].value,
          effet: inputs[1].value || '',
          niveau: parseInt(inputs[2].value) || 1
        });
      }
    });
  }
  return competences;
}

function getArmes() {
  const armes = [];
  const table = document.querySelector('.weapons-table tbody');
  if (table) {
    table.querySelectorAll('tr').forEach(row => {
      const type = row.querySelector('input[id^="weapon_type_"]')?.value;
      if (type) {
        armes.push({
          type: type,
          degats: row.querySelector('input[id^="weapon_dmg_"]')?.value || ''
        });
      }
    });
  }
  return armes;
}

// Fonction pour mettre à jour l'état de l'armure
function updateArmorState() {
  const duraMax = parseInt(document.getElementById('player_dura_max').value) || 0;
  const duraCurrent = parseInt(document.getElementById('player_dura_current').value) || 0;
  const armorStateInput = document.getElementById('player_armor');
  const armorStateEffect = document.getElementById('armor_effect');
  
  let etat = '';
  let couleur = '';
  let effect = '';
  
  if (duraCurrent === 0) {
    etat = "Absence d'armure";
    couleur = '#000000';
    effect = 'Plus aucune protection';
  } else if (duraCurrent >= ((duraMax/3)*2)+1) {
    etat = 'Armure Neuve';
    couleur = '#2e7d32';
    effect = 'Protection maximale';
  } else if (duraCurrent >= (duraMax/3)+1) {
    etat = 'Armure Abîmée';
    couleur = '#ff9800';
    effect = 'Bonus fixe supprimé';
  } else {
    etat = 'Armure Très Abîmée';
    couleur = '#d32f2f';
    effect = 'Résultat du jet réduite de moitié';
  }
  
  armorStateInput.value = etat;
  armorStateInput.style.color = couleur;
  armorStateEffect.textContent = effect;
  armorStateEffect.style.color = couleur;
}

// Ajouter ces écouteurs d'événements dans le DOMContentLoaded
document.getElementById('player_dura_current').addEventListener('input', updateArmorState);
document.getElementById('player_dura_max').addEventListener('input', updateArmorState);

// Appeler updateArmorState après le chargement initial des données
updateArmorState();

// Ajout des boutons pour ajouter des sorts
document.getElementById('add-sort-btn').addEventListener('click', () => {
  createSortElement({ nom: '', degats: '', niveau: '1' }, document.getElementById('sorts-container'), false);
});

document.getElementById('add-sort-mineur-btn').addEventListener('click', () => {
  createSortElement({ nom: '', degats: '' }, document.getElementById('sorts-mineurs-container'), true);
});

// Modifier l'événement du bouton add-attack-btn
document.getElementById('add-attack-spe-btn').addEventListener('click', async () => {
    const container = document.getElementById('attack-special-container');
    const attackRow = await createAttackElement({ nom: '', degats: '', niveau: '1' });
    if (attackRow) {
        container.appendChild(attackRow);
    }
});


async function createSortElement(sort, container, isMineur = false) {
  try {
    const response = await fetch('/api/game-database');
    if (!response.ok) throw new Error('Erreur de chargement des sorts');
    const gameData = await response.json();
    
    const sortRow = document.createElement('div');
    sortRow.className = 'sort-row';

    const nomSelect = document.createElement('select');
    nomSelect.className = isMineur ? 'minispell_name' : 'spell_name';
    
    const degatsInput = document.createElement('input');
    degatsInput.type = 'text';
    degatsInput.className = isMineur ? 'minispell_dmg' : 'spell_dmg';
    degatsInput.readOnly = true;

    const descBtn = document.createElement('button');
    descBtn.className = 'description-btn';
    descBtn.textContent = '?';
    descBtn.title = 'Voir la description';

    const descContent = document.createElement('div');
    descContent.className = 'description-content';

    const deleteBtn = document.createElement('button');
    deleteBtn.className = 'delete-btn';
    deleteBtn.textContent = '×';
    deleteBtn.title = 'Supprimer';
    
    // Option vide par défaut
    const defaultOption = document.createElement('option');
    defaultOption.value = '';
    defaultOption.textContent = 'Sélectionner un sort';
    nomSelect.appendChild(defaultOption);

    // Ajouter les options depuis la base de données
    const sorts = isMineur ? gameData.sorts_mineurs : gameData.sorts_majeurs;
    if (!Array.isArray(sorts)) {
      throw new Error('La liste des sorts n\'est pas un tableau valide');
    }

    sorts.forEach(sortData => {
      const option = document.createElement('option');
      option.value = sortData.nom;
      option.textContent = sortData.nom;
      option.dataset.degats = sortData.degats;
      option.dataset.niveau = sortData.niveau;
      option.dataset.description = sortData.description;
      // Sélectionner l'option si c'est le sort sauvegardé
      if (sortData.nom === sort.nom) {
        option.selected = true;
        descContent.textContent = option.dataset.description || 'Aucune description disponible';
      }
      nomSelect.appendChild(option);
    });

        // Sélectionner le sort si fourni
    if (sort && sort.nom) {
      const option = Array.from(nomSelect.options).find(opt => opt.value === sort.nom);
      if (option) {
        option.selected = true;
        degatsInput.value = sort.degats || '';
        descContent.textContent = option.dataset.description || 'Aucune description disponible';
      }
    }
    
    // Événements
    deleteBtn.addEventListener('click', () => sortRow.remove());

    descBtn.addEventListener('click', (e) => {
      e.preventDefault();
      descContent.classList.toggle('visible');
    });

    nomSelect.addEventListener('change', (e) => {
      const selectedOption = e.target.options[e.target.selectedIndex];
      degatsInput.value = selectedOption.dataset.degats || '';
      descContent.textContent = selectedOption.dataset.description || 'Aucune description disponible';
    });

    // Assemblage les éléments
    const titleContainer = document.createElement('div');
    titleContainer.style.display = 'flex';
    titleContainer.style.alignItems = 'center';
    titleContainer.appendChild(nomSelect);
    titleContainer.appendChild(descBtn);

    sortRow.appendChild(titleContainer);
    sortRow.appendChild(degatsInput);

    let niveauInput;
    if (!isMineur) {
      const niveauInput = document.createElement('input');
      niveauInput.type = 'number';
      niveauInput.min = '1';
      niveauInput.className = 'spell_lvl';
      niveauInput.value = sort.niveau || '1';
      niveauInput.readOnly = true;
      sortRow.appendChild(niveauInput);
    }
    sortRow.appendChild(deleteBtn); 
    sortRow.appendChild(descContent);
    

    container.appendChild(sortRow);

  } catch (error) {
    console.error('Erreur lors de la création du sort:', error);
    alert('Erreur lors de la création du sort: ' + error.message);
  }
}

// Ajouter la fonction pour créer une attaque spéciale
async function createAttackElement(attack) {
  try {
    console.log('Création d\'une attaque avec les données:', attack);
    
    const response = await fetch('/api/game-database');
    if (!response.ok) throw new Error('Erreur de chargement des attaques');
    const gameData = await response.json();
    
    console.log('Données du jeu reçues:', gameData.attack_special);
    
    const attackRow = document.createElement('div');
    attackRow.className = 'sort-row';

    // Select pour le nom de l'attaque
    const nomSelect = document.createElement('select');
    nomSelect.className = 'attack_name';
    
    // Option par défaut
    const defaultOption = document.createElement('option');
    defaultOption.value = '';
    defaultOption.textContent = 'Sélectionner une attaque';
    nomSelect.appendChild(defaultOption);

    // Ajouter les options depuis la base de données
    const attacks = gameData.attack_special || [];
    attacks.forEach(attackData => {
      const option = document.createElement('option');
      option.value = attackData.nom;
      option.textContent = attackData.nom;
      option.dataset.degats = attackData.degats;
      option.dataset.niveau = attackData.niveau;
      option.dataset.description = attackData.description;
      nomSelect.appendChild(option);
    });

    // Input pour les dégâts
    const degatsInput = document.createElement('input');
    degatsInput.type = 'text';
    degatsInput.className = 'attack_dmg';
    degatsInput.readOnly = true;

    // Input pour le niveau
    const niveauInput = document.createElement('input');
    niveauInput.type = 'number';
    niveauInput.min = '1';
    niveauInput.className = 'attack_lvl';
    niveauInput.readOnly = true;

    // Ajouter le bouton de suppression
    const deleteBtn = document.createElement('button');
    deleteBtn.className = 'delete-btn';
    deleteBtn.textContent = '×';
    deleteBtn.title = 'Supprimer';
    deleteBtn.addEventListener('click', () => {
      attackRow.remove();
    });

    // Ajouter le bouton de description
    const descBtn = document.createElement('button');
    descBtn.className = 'description-btn';
    descBtn.textContent = '?';
    descBtn.title = 'Voir la description';

    // Créer la div pour la description
    const descContent = document.createElement('div');
    descContent.className = 'description-content';

    // Événement pour afficher/masquer la description
    descBtn.addEventListener('click', (e) => {
      e.preventDefault();
      descContent.classList.toggle('visible');
    });

    // Ajouter les éléments à la ligne
    attackRow.appendChild(nomSelect);
    attackRow.appendChild(degatsInput);
    attackRow.appendChild(niveauInput);
    attackRow.appendChild(deleteBtn);

    // Sélectionner l'attaque existante si elle existe
    if (attack && attack.nom) {
      const option = Array.from(nomSelect.options).find(opt => opt.value === attack.nom);
      if (option) {
        option.selected = true;
        degatsInput.value = attack.degats || '';
        niveauInput.value = attack.niveau || '1';
        descContent.textContent = option.dataset.description || 'Aucune description disponible';
      }
    }

    // Événement de changement de l'attaque
    nomSelect.addEventListener('change', (e) => {
      const selectedOption = e.target.options[e.target.selectedIndex];
      degatsInput.value = selectedOption.dataset.degats || '';
      niveauInput.value = selectedOption.dataset.niveau || '1';
      // Mettre à jour la description
      const description = selectedOption.dataset.description || 'Aucune description disponible';
      descContent.textContent = description;
    });

    // Ajouter les éléments à la ligne
    const titleContainer = document.createElement('div');
    titleContainer.style.display = 'flex';
    titleContainer.style.alignItems = 'center';
    titleContainer.appendChild(nomSelect);
    titleContainer.appendChild(descBtn);

    attackRow.appendChild(titleContainer);
    attackRow.appendChild(degatsInput);
    attackRow.appendChild(niveauInput);
    attackRow.appendChild(deleteBtn);
    attackRow.appendChild(descContent);

    return attackRow;
  } catch (error) {
    console.error('Erreur lors de la création de l\'attaque:', error);
    throw error;
  }
}

/*// Ajouter les écouteurs d'événements pour la durabilité
document.getElementById('player_dura_current').addEventListener('input', updateArmorState);
document.getElementById('player_dura_max').addEventListener('input', updateArmorState);

// Appeler updateArmorState après le remplissage initial des champs
window.addEventListener('DOMContentLoaded', () => {
  // ...code existant...

  // Appeler updateArmorState après le remplissage des champs
  updateArmorState();
});*/

  </script>
</body>
</html>