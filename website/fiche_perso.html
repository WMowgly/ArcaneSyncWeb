<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Fiche de Personnage</title>
  <link href="https://fonts.googleapis.com/css2?family=Uncial+Antiqua&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css"/> 
  <style>
    body {
      font-family: 'Uncial Antiqua', cursive;
      background-size: cover;
      background-color: #fdf6e3;
      color: #3b2f1e;
      margin: 0;
      padding: 40px;
    }

    h1, h2 {
      text-align: center;
      text-shadow: 1px 1px 2px #00000050;
    }

    .section {
      position: relative;
      background: rgba(255, 248, 220, 0.9);
      border: 4px solid #8b5e3c;
      border-radius: 12px;
      padding: 50px 20px 20px 20px;
      margin-bottom: 30px;
      box-shadow: 0 0 10px #3b2f1e99;
      overflow: hidden;
    }

    .section h2 {
      position: absolute;
      top: -20px;
      left: 20px;
      background: rgba(255, 248, 220, 0.95);
      padding: 0 10px;
      font-size: 20px;
      color: #5c3b21;
      border: 2px solid #8b5e3c;
      border-radius: 8px;
      box-shadow: 2px 2px 4px #00000040;
      z-index: 2;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 15px;
    }

    .grid-3 {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
    }

    .field {
      display: flex;
      flex-direction: column;
    }

    label {
      font-weight: bold;
      margin-bottom: 5px;
      color: #3b2f1e;
    }

    input, textarea {
      font-family: 'Uncial Antiqua', cursive;
      padding: 6px 10px;
      font-size: 16px;
      background: #fefae0;
      border: 2px solid #8b5e3c;
      border-radius: 6px;
      box-shadow: inset 0 0 4px #8b5e3c44;
      box-sizing: border-box;
      width: 100%;
    }

    textarea {
      resize: vertical;
      height: 150px;
    }

    #save-data-btn {
      font-family: 'Uncial Antiqua', cursive;
      padding: 10px 30px;
      font-size: 18px;
      background: #8b5e3c;
      color: #fefae0;
      border: 2px solid #5c3b21;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 2px 2px 4px #3b2f1e66;
      transition: all 0.3s ease;
      margin: 20px 0;
    }

    #save-data-btn:hover {
      background: #5c3b21;
      transform: translateY(-2px);
      box-shadow: 3px 3px 6px #3b2f1e88;
    }

    #save-data-btn:active {
      transform: translateY(0);
      box-shadow: 1px 1px 3px #3b2f1e44;
    }

    .competences-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    .competences-table th, .competences-table td {
      border: 1px solid #8b5e3c;
      padding: 8px;
      text-align: left;
    }

    .competences-table th {
      background-color: rgba(139, 94, 60, 0.2);
    }

    .spells-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
    }

    .spell-item {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 5px;
      margin-bottom: 10px;
    }

    .spell-item label {
      grid-column: 1 / -1;
      margin-bottom: 0;
    }

    @media (max-width: 768px) {
      .grid, .grid-3 {
        grid-template-columns: repeat(2, 1fr);
      }
      .spells-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 480px) {
      .grid, .grid-3 {
        grid-template-columns: 1fr;
      }
    }

    select {
      font-family: 'Uncial Antiqua', cursive;
      padding: 6px 10px;
      font-size: 16px;
      background: #fefae0;
      border: 2px solid #8b5e3c;
      border-radius: 6px;
      box-shadow: inset 0 0 4px #8b5e3c44;
      box-sizing: border-box;
      width: 100%;
      color: #3b2f1e;
      cursor: pointer;
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%238b5e3c' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 10px center;
      background-size: 16px;
      padding-right: 30px;
    }

    select:hover {
      border-color: #5c3b21;
      background-color: #fff8dc;
    }

    select:focus {
      outline: none;
      border-color: #5c3b21;
      box-shadow: 0 0 0 2px #8b5e3c33;
    }

    select option {
      background: #fefae0;
      color: #3b2f1e;
      padding: 8px;
    }

    .header-fields {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 15px;
      margin-bottom: 20px;
    }

    .niveau-race {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 10px;
    }

    .double-section-container {
        display: flex;
        gap: 30px;
        margin-bottom: 30px;
    }

    .double-section-container .section {
        flex: 1;
    }

    .sort-row {
      background: rgba(139, 94, 60, 0.1);
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 8px;
      display: grid;
      grid-template-columns: 2fr 1fr 1fr;
      gap: 10px;
      align-items: center;
    }

    .add-btn {
      font-family: 'Uncial Antiqua', cursive;
      background: #8b5e3c;
      color: #fefae0;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 10px;
    }

    .add-btn:hover {
      background: #5c3b21;
    }

  </style>
</head>
<body>
  <div id="navbar-placeholder"></div>
  <h1>Fiche de Personnage v2</h1>

  <div class="section">
    <h2>Informations Générales</h2>
    <div class="grid">
      <div class="field"><label>Nom</label><input type="text" id="player_name" readonly></div>
      <div class="field"><label>Classe</label><select id="player_class"></select></div>
      <div class="field"><label>Race</label><select id="player_race"></select></div>
      <div class="field"><label>Niveau</label><input type="number" id="player_level" min="1"></div>
    </div>
  </div>

  <div class="section">
    <h2>Statistiques</h2>
    <div class="grid">
      <div class="field"><label>Force</label><input type="number" id="stat_force"></div>
      <div class="field"><label>Dexterite</label><input type="number" id="stat_dexterite"></div>
      <div class="field"><label>Magie</label><input type="number" id="stat_magie"></div>
      <div class="field"><label>Constitution</label><input type="number" id="stat_constitution"></div>
      <div class="field"><label>Charisme</label><input type="number" id="stat_charisme"></div>
      <div class="field"><label>Perception</label><input type="number" id="stat_perception"></div>
      <div class="field"><label>Chance</label><input type="number" id="stat_chance"></div>
      <div class="field"><label>Intelligence</label><input type="number" id="stat_intelligence"></div>
    </div>
  </div>

  <div class="section">
    <h2>Survie et Défense</h2>
    <div class="grid">
      <div class="field">
        <label>Jets de survie</label>
        <div style="display: flex; flex-direction: column; gap: 10px;">
          <!-- Ligne des "Réussi" -->
          <div style="display: flex; align-items: center;">
            <span class="divider-span">Réussi</span>
            <div style="display: flex; gap: 20px;">
              <input type="checkbox" name="survie1" value="reussi">
              <input type="checkbox" name="survie2" value="reussi">
              <input type="checkbox" name="survie3" value="reussi">
            </div>
          </div>
          <!-- Ligne des "Echec" -->
          <div style="display: flex; align-items: center;">
            <span class="divider-span">Échec</span>
            <div style="display: flex; gap: 20px;">
              <input type="checkbox" name="survie1" value="echec">
              <input type="checkbox" name="survie2" value="echec">
              <input type="checkbox" name="survie3" value="echec">
            </div>
          </div>
        </div>
      </div>
        <div class="field">
        <label>Vie</label>
        <div class="dual-input">
          <input type="number" id="player_hp_current" min="0" placeholder="Min">
          <span class="divider-span">/</span>
          <input type="number" id="player_hp" readonly>
        </div>
      </div>

      <div class="field">
        <label>Mana</label>
        <div class="dual-input">
          <input type="number" id="player_mana_current" min="0" placeholder="Min">
          <span class="divider-span">/</span>
          <input type="number" id="player_mana" readonly>
        </div>
      </div>

      <div class="field" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <div style="display: flex; flex-direction: column;">
          <label>Vie bonus</label>
          <input type="number" id="player_vie_bonus" min="0" placeholder="0">
        </div>
        <div style="display: flex; flex-direction: column;">
          <label>Intox.</label>
          <input type="number" id="player_intox" placeholder="0" min="0" max="100">
        </div>
      </div>

    </div><!-- fin du grid -->
  </div>

    <div class="sections-container">
        <!-- Section Sac -->
        <div class="section">
            <h2>Sac</h2>
            <div class="content-area">
                <textarea></textarea>
            </div>
        </div>
    
        <!-- Section Ceinture/dos -->
        <div class="section">
            <h2>Ceinture/dos</h2>
            <div class="content-area">
                <textarea></textarea>
            </div>
        </div>
    
        <!-- Section Armes -->
        <div class="section">
            <h2>Armes</h2>
            <table class="weapons-table">
                <thead>
                    <tr>
                        <th>Type</th>
                        <th>Dégâts</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td><input type="text"></td><td><input type="text"></td></tr>
                    <tr><td><input type="text"></td><td><input type="text"></td></tr>
                    <tr><td><input type="text"></td><td><input type="text"></td></tr>
                    <tr><td><input type="text"></td><td><input type="text"></td></tr>
                    <tr><td><input type="text"></td><td><input type="text"></td></tr>
                </tbody>
            </table>
        </div>
    
        <!-- Section Armure -->
        <div class="section">
            <h2>Armure</h2>
            <div class="armor-section">
                <div class="armor-fields">
                    <div class="field"><label>Type d'armure</label><select id="eq_armure"></select></div>
                    <div class="field"><label>Résistance</label><input type="text"></div>
                    <div class="field">
                      <label>Durabilité</label>
                      <div class="dual-input">
                        <input type="number" id="player_dura_current" min="0" placeholder="0">
                        <span class="divider-span">/</span>
                        <input type="number" id="player_dura_max" placeholder="Max" readonly>
                      </div>
                    </div>
      
                    <div class="field">
                      <label>État de l'armure</label>
                      <input type="text" id="player_armor" readonly>
                      <div id="armor_effect" class="status-text"></div>
                    </div>
                    <div class="field">
                      <label>Valeur de Protection</label>
                      <div class="dual-input">
                        <input type="number" id="def_protection" min="0" placeholder="0">
                        <span class="divider-span">/</span>
                        <input type="number" id="def_protection_max" placeholder="Max" readonly>
                      </div>
                    </div>
                  </div>
            </div>
        </div>
    </div>


    <div class="double-section-container">
        <div class="section">
            <h2>Sorts</h2>
            <div id="sorts-container">
                <!-- Les sorts seront ajoutés ici dynamiquement -->
            </div>
            <button type="button" class="add-btn" id="add-sort-btn">Ajouter un sort</button>
        </div>
            
        <div class="section">
            <h2>Attaques Spéciales</h2>
            <div class="grid-3">
                <div class="field"><label>Nom</label><input type="text"></div>
                <div class="field"><label>Dégâts</label><input type="text"></div>
                <div class="field"><label>Niveau</label><input type="number" min="1"></div>
                <div class="field"><label>Nom</label><input type="text"></div>
                <div class="field"><label>Dégâts</label><input type="text"></div>
                <div class="field"><label>Niveau</label><input type="number" min="1"></div>
                <div class="field"><label>Nom</label><input type="text"></div>
                <div class="field"><label>Dégâts</label><input type="text"></div>
                <div class="field"><label>Niveau</label><input type="number" min="1"></div>
            </div>
        </div>
    </div>

    <div class="section">
        <h2>Sorts mineurs</h2>
        <div id="sorts-mineurs-container">
            <!-- Les sorts mineurs seront ajoutés ici dynamiquement -->
        </div>
        <button type="button" class="add-btn" id="add-sort-mineur-btn">Ajouter un sort mineur</button>
    </div>

  <div class="section">
    <h2>Compétences de classe et passifs</h2>
    <table class="competences-table">
      <thead>
        <tr>
          <th>Nom</th>
          <th>Effets</th>
          <th>Niveau</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td><input type="number" min="1"></td>
        </tr>
        <tr>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td><input type="number" min="1"></td>
        </tr>
        <tr>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td><input type="number" min="1"></td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="section">
    <h2>Compétences spéciales du personnage</h2>
    <div class="field">
      <textarea></textarea>
    </div>
  </div>

  <div class="section">
    <h2>Biographie</h2>
    <div class="field">
      <textarea></textarea>
    </div>
  </div>

  <div class="section">
    <h2>Choix de level up et Effets permanents</h2>
    <div class="field">
      <textarea></textarea>
    </div>
  </div>

  <div style="text-align: center;">
    <button id="save-data-btn" type="button" onclick="console.log('Clic direct')">Sauvegarder</button>
  </div>

  <script src="navbar.js"></script>
  <script>
    function getFieldValue(selector, defaultValue = '') {
      const element = document.querySelector(selector);
      return element ? element.value || defaultValue : defaultValue;
    }

    function getNumericValue(selector, defaultValue = 0) {
      const value = getFieldValue(selector);
      return parseInt(value) || defaultValue;
    }
    // Options de sélection
      const options = {
        "classes": ["Guerrier", "Paladin", "Mage", "Marchand", "Ranger", "Druide", "Aventurier", "Sorceleur"],
        "races": ["Humain", "Nain", "Elfe", "Draconnir", "Demi-Elfe", "Humnigar", "Ecorfal"],
        "armures": ["Armure légère", "Armure moyenne", "Armure lourde"]
      };

      // Remplir la liste déroulante des classes
      const classSelect = document.getElementById('player_class');
      options.classes.forEach(className => {
        const option = document.createElement('option');
        option.value = className;
        option.textContent = className;
        classSelect.appendChild(option);
      });

      // Remplir la liste déroulante des races
      const raceSelect = document.getElementById('player_race');
      options.races.forEach(raceName => {
        const option = document.createElement('option');
        option.value = raceName;
        option.textContent = raceName;
        raceSelect.appendChild(option);
      });

      // Remplir la liste déroulante des armures
      const armorSelect = document.getElementById('eq_armure');
      options.armures.forEach(armorName => {
        const option = document.createElement('option');
        option.value = armorName;
        option.textContent = armorName;
        armorSelect.appendChild(option);
      });

      window.addEventListener('DOMContentLoaded', () => {
  const params = new URLSearchParams(window.location.search);
  
  // Fonction utilitaire pour récupérer les valeurs des paramètres
  function getParamValue(key, defaultValue = '') {
    const value = params.get(key);
    return value !== 'null' && value !== 'undefined' ? value : defaultValue;
  }

  // Fonction pour remplir un champ avec une valeur
  function fillField(id, value) {
    const element = document.getElementById(id);
    if (element) element.value = value;
  }

  // Remplir les champs avec les valeurs de l'URL
  fillField('player_name', getParamValue('Nom'));
  fillField('player_class', getParamValue('Classe'));
  fillField('player_race', getParamValue('Race'));
  fillField('player_level', getParamValue('Niveau', '1'));
  
  // Stats vitales
  fillField('player_hp', getParamValue('VieMax', '0'));
  fillField('player_hp_current', getParamValue('VieCurrent', '0'));
  fillField('player_mana', getParamValue('ManaMax', '0'));
  fillField('player_mana_current', getParamValue('ManaCurrent', '0'));
  
  // Stats de base
  const stats = ['Force', 'Dextérité', 'Magie', 'Constitution', 'Charisme', 'Perception', 'Chance', 'Intelligence'];
  stats.forEach(stat => {
    fillField(`stat_${stat.toLowerCase()}`, getParamValue(stat, '0'));
  });
  
  // Équipement et protection
  fillField('player_vie_bonus', getParamValue('Vie bonus', '0'));
  fillField('def_protection_max', getParamValue('Valeur protection', '0'));
  fillField('player_intox', getParamValue('Intox.', '0'));
  fillField('eq_armure', getParamValue("Type d'armure"));
  fillField('eq_resistance', getParamValue('Résistance'));
  fillField('player_dura_max', getParamValue('DuraMax', '0'));
  fillField('player_dura_current', getParamValue('DuraCurrent', '0'));

  // Gestionnaire de sauvegarde
  document.getElementById('save-data-btn').addEventListener('click', async () => {
    
    try {
    // Construire l'objet de données
    const donnees = {
      nom: document.getElementById('player_name').value,
      classe: document.getElementById('player_class').value,
      race: document.getElementById('player_race').value,
      niveau: parseInt(document.getElementById('player_level').value) || 1,
      stats: {
        force: parseInt(document.getElementById('stat_force').value) || 0,
        dexterite: parseInt(document.getElementById('stat_dexterite').value) || 0,
        magie: parseInt(document.getElementById('stat_magie').value) || 0,
        constitution: parseInt(document.getElementById('stat_constitution').value) || 0,
        charisme: parseInt(document.getElementById('stat_charisme').value) || 0,
        perception: parseInt(document.getElementById('stat_perception').value) || 0,
        chance: parseInt(document.getElementById('stat_chance').value) || 0,
        intelligence: parseInt(document.getElementById('stat_intelligence').value) || 0
      },
      bio: document.getElementById('bio').value || '',
      sac: document.getElementById('eq_sac').value || '',
      ceinture: document.getElementById('eq_ceinture').value || '',
      armure: {
        type: document.getElementById('eq_armure').value,
        resistance: document.getElementById('eq_resistance').value,
        durabilite: {
          max: parseInt(document.getElementById('eq_durabilite').value) || 0,
          current: parseInt(document.getElementById('eq_durabilite_current').value) || 0
        },
        protection: {
          max: parseInt(document.getElementById('def_protection_max').value) || 0,
          current: parseInt(document.getElementById('def_protection').value) || 0
        },
      },
      hp: {
        max: parseInt(document.getElementById('player_hp').value) || 0,
        current: parseInt(document.getElementById('player_hp_current').value) || 0
      },
      mana: {
        max: parseInt(document.getElementById('player_mana').value) || 0,
        current: parseInt(document.getElementById('player_mana_current').value) || 0
      },
      bonus_vie: parseInt(document.getElementById('def_bonus_vie').value) || 0,
      intox: document.getElementById('def_intox').value || '0',
      spells: getSpells(),
      sorts_mineurs: getSortsMineurs(),
      competences: getCompetences(),
      skills_speciales: document.getElementById('skills_speciales').value || '',
      levelup: document.getElementById('levelup').value || '',
      armes: getArmes()
    };

      const response = await fetch('/api/joueur/save', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(donnees)
      });

      if (!response.ok) throw new Error('Erreur de sauvegarde');

      alert('Sauvegarde réussie !');

      // Mise à jour de l'URL avec les nouvelles valeurs
      const newParams = new URLSearchParams();
      Object.entries(donnees).forEach(([key, value]) => {
        if (typeof value !== 'object') {
          newParams.set(key, value);
        }
      });
      
      window.history.pushState({}, '', `${window.location.pathname}?${newParams.toString()}`);
      alert('Sauvegarde réussie !');

    } catch (error) {
      console.error('Erreur:', error);
      alert('Erreur lors de la sauvegarde');
    }
  });
});

// Ajouter ces fonctions utilitaires
function getSpells() {
  const spells = [];
  for (let i = 1; i <= 3; i++) {
    const nom = document.getElementById(`spell_name_${i}`)?.value;
    if (nom) {
      spells.push({
        nom: nom,
        degats: document.getElementById(`spell_dmg_${i}`)?.value || '',
        niveau: parseInt(document.getElementById(`spell_lvl_${i}`)?.value) || 1
      });
    }
  }
  return spells;
}

function getSortsMineurs() {
  const sortsMineurs = [];
  for (let i = 1; i <= 2; i++) {
    const nom = document.getElementById(`minispell_name_${i}`)?.value;
    if (nom) {
      sortsMineurs.push({
        nom: nom,
        degats: document.getElementById(`minispell_dmg_${i}`)?.value || ''
      });
    }
  }
  return sortsMineurs;
}

function getCompetences() {
  const competences = [];
  for (let i = 1; i <= 3; i++) {
    const nom = document.getElementById(`class_skill_name_${i}`)?.value;
    if (nom) {
      competences.push({
        nom: nom,
        effet: document.getElementById(`class_skill_effect_${i}`)?.value || '',
        niveau: parseInt(document.getElementById(`class_skill_lvl_${i}`)?.value) || 1
      });
    }
  }
  return competences;
}

function getArmes() {
  const armes = [];
  for (let i = 1; i <= 5; i++) {
    const type = document.getElementById(`weapon_type_${i}`)?.value;
    if (type) {
      armes.push({
        type: type,
        degats: document.getElementById(`weapon_dmg_${i}`)?.value || ''
      });
    }
  }
  return armes;
}
  </script>
</body>
</html>