<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MJ - ArcaneSync</title>
  <link rel="stylesheet" href="style.css"/> 
  <link rel="icon" type="image/png" href="img/icon.png"/>
  <script src="/socket.io/socket.io.js"></script> 
</head>
<body>
  <div id="navbar-placeholder"></div>
  <h1>Interface du Maitre du Jeu</h1>

  <h2>Liste des joueurs</h2>
  <div id="joueurs-list"></div>

  <script src="navbar.js"></script>
  <script type="module">
    import { showMJPopup } from './popupmj.js';

    // Fonction pour charger et afficher les joueurs
    function getArmorState(duraCurrent, duraMax) {
      if (duraCurrent === 0) {
        return {
          etat: "Absence d'armure",
          couleur: '#000000'
        };
      } else if (duraCurrent >= ((duraMax/3)*2)+1) {
        return {
          etat: 'Armure Neuve',
          couleur: '#2e7d32'
        };
      } else if (duraCurrent >= (duraMax/3)+1) {
        return {
          etat: 'Armure Abîmée',
          couleur: '#ff9800'
        };
      } else {
        return {
          etat: 'Armure Très Abîmée',
          couleur: '#d32f2f'
        };
      }
    }

    function loadAndDisplayPlayers() {
      fetch('/api/joueurs')
        .then(response => response.json())
        .then(joueurs => {
          const listContainer = document.getElementById('joueurs-list');
          listContainer.innerHTML = '';
          
          if (joueurs.length === 0) {
            listContainer.innerHTML = '<p>Aucun joueur enregistré.</p>';
            return;
          }

          joueurs.forEach(joueur => {
            const card = document.createElement('div');
            card.classList.add('card');
            card.setAttribute('data-id', joueur.nom);

            // Calcul de l'état de l'armure
            const duraCurrent = joueur.equipement?.durabilite?.current || 0;
            const duraMax = joueur.equipement?.durabilite?.max || 0;
            const armorState = getArmorState(duraCurrent, duraMax);

            card.innerHTML = `
              <h3>${joueur.nom}</h3>
              <p>HP: ${joueur.hp?.current} / ${joueur.hp?.max}</p>
              <p>Mana: ${joueur.mana?.current} / ${joueur.mana?.max}</p>
              <p>Protection: ${joueur.defense?.protection} / ${joueur.defense?.protection_max}</p>
              <p>État armure: <span style="color: ${armorState.couleur}">${armorState.etat}</span></p>
            `;

            card.addEventListener('click', () => {
              showMJPopup(joueur);
            });

            listContainer.appendChild(card);
          });
        })
        .catch(err => {
          console.error("Erreur lors de la récupération des joueurs:", err);
          alert("Erreur lors de la récupération des joueurs.");
        });
    }

    // Charger les joueurs initialement
    loadAndDisplayPlayers();

    // Configurer WebSocket
    const socket = io();
    
    // Écouter les mises à jour
    socket.on('playerUpdate', (data) => {
      console.log('Mise à jour reçue:', data);
      loadAndDisplayPlayers();
    });
  </script>
</body>
</html>